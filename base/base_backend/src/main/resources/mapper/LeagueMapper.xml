<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.nextplayer.base.backend.mapper.LeagueMapper">

    <!-- 학원클럽 - 요약정보 - 참가리그 리스트 -->
    <select id="selectTeamEnterLeague" parameterType="hashmap" resultType="hashmap">
        SELECT *
        FROM
        (
        SELECT *
        FROM
        (
        SELECT a.l_league_id, b.league_name	, b.play_sdate
        FROM
        (
        SELECT team_id AS l_team_id, league_id AS l_league_id
        FROM ${leagueTeamTB}
        WHERE use_flag = 0
        AND team_id = #{teamId}
        ) a INNER JOIN
        (
        SELECT league_id AS info_league_id, league_name, play_sdate
        FROM ${leagueInfoTB}
        WHERE use_flag = 0

        <choose>
            <when test="sYear != null and sYear != '' ">
                AND play_sdate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND play_sdate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
                AND play_edate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND play_edate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
            </when>
            <otherwise>
                AND play_sdate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND play_sdate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
                AND play_edate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND play_edate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
            </otherwise>
        </choose>
        ) b
        ON a.l_league_id = b.info_league_id
        ) a LEFT JOIN
        (
        SELECT team_id,league_id,`rank`,played, SUM(points + points_add) AS points, won,draw,lost,gf,ga,gd,reg_date,mod_date
        FROM ${leagueResultTB}
        WHERE use_flag = 0
        GROUP BY league_id, team_id
        ) b
        ON a.l_league_id = b.league_id
        ) a INNER JOIN
        (
        SELECT team_id, uage, area_name, team_type, team_name, nick_name, emblem, use_flag
        FROM Team
        ) b
        ON a.team_id = b.team_id
        ORDER BY a.play_sdate DESC, a.`rank` ASC

    </select>

    <!-- 학원클럽 -  요약정보 - 리그 경기결과 리스트 -->
    <select id="selectTeamLeagueMatch" parameterType="hashmap" resultType="hashmap">
        SELECT a.league_match_id,
        DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
        a.match_date, a.place,

        a.home_id, a.home,  a.home_score,
        b.emblem AS home_emblem, b.team_type AS home_type,
        a.away_id, a.away, a.away_score,
        c.emblem AS away_emblem, c.team_type AS away_type,
        a.match_type, a.reason, a.league_id,
        a.match_order,
        a.match_status
        FROM ${leagueMatchTB} a
        INNER JOIN Team b
        ON a.home_id = b.team_id
        INNER JOIN Team c
        ON a.away_id  = c.team_id
        WHERE a.use_flag = 0
        AND a.home_id = #{teamId}

        <choose>
            <when test="sYear != null and sYear != '' ">
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
            </when>
            <otherwise>
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
            </otherwise>
        </choose>

        UNION

        SELECT a.league_match_id,
        DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
        a.match_date, a.place,

        a.home_id, a.home,  a.home_score,
        b.emblem AS home_emblem, b.team_type AS home_type,
        a.away_id, a.away, a.away_score,
        c.emblem AS away_emblem, c.team_type AS away_type,
        a.match_type, a.reason, a.league_id,
        a.match_order,
        a.match_status
        FROM ${leagueMatchTB} a
        INNER JOIN Team b
        ON a.home_id = b.team_id
        INNER JOIN Team c
        ON a.away_id  = c.team_id
        WHERE a.use_flag = 0
        AND a.away_id = #{teamId}

        <choose>
            <when test="sYear != null and sYear != '' ">
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
            </when>
            <otherwise>
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND SUBSTRING_INDEX(a.match_date , ' ', 1) <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
            </otherwise>
        </choose>

        ORDER BY pdate DESC
    </select>

    <!-- 학원클럽 - 리그정보 - 리그 경기 결과 -->
    <select id="selectTeamEnterLeagueMatch" parameterType="hashmap" resultType="hashmap">
        SELECT a.league_match_id, a.league_name,
        SUBSTRING_INDEX(a.match_date,' ',2 ) AS playdate,
        DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
        SUBSTRING_INDEX(a.match_date,' ',-1 ) AS ptime,
        a.match_date, a.place,

        IF(home_score <![CDATA[>]]> away_score , '승', IF(home_score <![CDATA[<]]> away_score, '패', '무')) AS win_type,

        a.home_id, a.home,  a.home_score,
        b.emblem AS home_emblem, b.team_type AS home_type,
        a.away_id, a.away, a.away_score,
        c.emblem AS away_emblem, c.team_type AS away_type,
        a.match_type, a.reason, a.league_id

        FROM ${leagueMatchTB} a
        INNER JOIN Team b
        ON a.home_id = b.team_id
        INNER JOIN Team c
        ON a.away_id  = c.team_id
        WHERE a.use_flag = 0
        AND home_id = #{teamId}

        <choose>
            <when test="sYear != null and sYear != '' ">
                AND DATE_FORMAT(SUBSTRING_INDEX(a.match_date,' ',1 ), '%Y') = #{sYear}
            </when>
            <otherwise>
                AND DATE_FORMAT(SUBSTRING_INDEX(a.match_date,' ',1 ), '%Y') = DATE_FORMAT(CURDATE(), '%Y')
            </otherwise>
        </choose>

        UNION

        SELECT a.league_match_id, a.league_name,
        SUBSTRING_INDEX(a.match_date,' ',2 ) AS playdate,
        DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
        SUBSTRING_INDEX(a.match_date,' ',-1 ) AS ptime,
        a.match_date, a.place,

        IF(home_score <![CDATA[>]]> away_score , '패', IF(home_score <![CDATA[<]]> away_score, '승', '무')) AS win_type,

        a.home_id, a.home,  a.home_score,
        b.emblem AS home_emblem, b.team_type AS home_type,
        a.away_id, a.away, a.away_score,
        c.emblem AS away_emblem, c.team_type AS away_type,
        a.match_type, a.reason, a.league_id

        FROM ${leagueMatchTB} a
        INNER JOIN Team b
        ON a.home_id = b.team_id
        INNER JOIN Team c
        ON a.away_id  = c.team_id
        WHERE a.use_flag = 0
        AND away_id = #{teamId}

        <choose>
            <when test="sYear != null and sYear != '' ">
                AND DATE_FORMAT(SUBSTRING_INDEX(a.match_date,' ',1 ), '%Y') = #{sYear}
            </when>
            <otherwise>
                AND DATE_FORMAT(SUBSTRING_INDEX(a.match_date,' ',1 ), '%Y') = DATE_FORMAT(CURDATE(), '%Y')
            </otherwise>
        </choose>

        ORDER BY pdate DESC
    </select>

    <!-- 학원클럽 - 리그정보 - 연도별 리그 승무패  -->
    <select id="selectTeamLeagueResultByYear" parameterType="hashmap" resultType="hashmap">
        SELECT DATE_FORMAT( play_sdate, '%Y') AS play_year, SUM(won) AS won, SUM(draw) AS draw, SUM(lost) AS lost
        FROM
            (
                SELECT league_id AS info_league_id, league_name, play_sdate
                FROM ${leagueInfoTB}
                WHERE use_flag = 0
            ) a INNER JOIN
            (
                SELECT team_id,league_id,played, won,draw,lost
                FROM ${leagueResultTB}
                WHERE use_flag = 0
                  AND team_id = #{teamId}
            ) b
            ON a.info_league_id = b.league_id
        GROUP BY DATE_FORMAT( a.play_sdate , "%Y" ) ASC
    </select>

    <!-- 학원클럽 - 리그정보 - 리그 순위 추이 -->
    <select id="selectTeamLeagueRankByYear" parameterType="hashmap" resultType="hashmap">
        SELECT team_id, DATE_FORMAT( play_sdate, '%Y') AS play_year, `rank` , league_name
        FROM
            (
                SELECT league_id, league_name, play_sdate
                FROM ${leagueInfoTB}
                WHERE use_flag = 0
            ) a INNER JOIN
            (
                SELECT team_id, league_id, `rank`
                FROM ${leagueResultTB}
                WHERE use_flag = 0
                  AND team_id = #{teamId}
            ) b
            ON a.league_id = b.league_id
        GROUP BY DATE_FORMAT( play_sdate, '%Y'), a.league_id
    </select>

    <!-- 학원클럽 - 리그정보 - 리그 평균 득/실점 추이 -->
    <select id="selectTeamLeagueAvgGoalByYear" parameterType="hashmap" resultType="hashmap">
        SELECT team_id, DATE_FORMAT( play_sdate, '%Y') AS play_year,
               SUM(played) AS played,
               SUM(gf) AS gf,
               SUM(ga) AS ga,
               TRUNCATE(IFNULL(SUM(gf), 0) / IFNULL(SUM(played), 0), 1) AS avg_gf,
               TRUNCATE(IFNULL(SUM(ga), 0) / IFNULL(SUM(played), 0), 1) AS avg_ga
        FROM
            (
                SELECT league_id, play_sdate
                FROM ${leagueInfoTB}
                WHERE use_flag = 0
            ) a INNER JOIN
            (
                SELECT team_id, league_id,played,gf,ga
                FROM ${leagueResultTB}
                WHERE use_flag = 0
                  AND team_id = #{teamId}
            ) b
            ON a.league_id = b.league_id
        GROUP BY DATE_FORMAT( play_sdate, '%Y')
    </select>

    <!-- 리그 정보  -->
    <select id="selectLeagueInfoListCount" parameterType="hashmap" resultType="hashmap">
        SELECT COUNT(*) AS totalCount
        FROM ${leagueInfoTB}
        WHERE use_flag = 0

        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1') ">
            AND area_name = #{sArea}
        </if>
        <if test="sLeagueName != null and !sLeagueName.equals('')  ">
            AND league_name LIKE CONCAT('%',#{sLeagueName},'%')
        </if>
        <if test="sYear != null and !sYear.equals('')">
            AND (play_sdate BETWEEN CONCAT(#{sYear}, '-01-01 00:00:00') AND CONCAT(#{sYear}, '-12-31 23:59:59') OR
            play_edate BETWEEN CONCAT(#{sYear}, '-01-01 00:00:00') AND CONCAT(#{sYear}, '-12-31 23:59:59'))
        </if>
    </select>

    <select id="selectLeagueInfoList" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.league_id, a.area_name, a.league_name,
            DATE_FORMAT(a.play_sdate, '%Y.%m.%d') AS play_sdate,
            DATE_FORMAT(a.play_edate, '%Y.%m.%d') AS play_edate,
            a.play_flag ,
            CASE
                WHEN now() <![CDATA[>]]> a.play_edate THEN '종료'
                WHEN now() BETWEEN a.play_sdate AND a.play_edate THEN '진행중'
                WHEN now() <![CDATA[<]]> a.play_sdate THEN '예정'
            END AS progress,
            league_info,
            IFNULL(b.ltCnt, 0) AS ltCnt
        FROM ${leagueInfoTB} a
        LEFT JOIN
                (
                    SELECT COUNT(*) AS ltCnt, league_id FROM ${leagueTeamTB} WHERE use_flag = 0 GROUP BY league_id
                )b ON a.league_id = b.league_id
        WHERE a.use_flag = 0

        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1')  ">
            AND a.area_name = #{sArea}
        </if>
        <if test="sLeagueName != null and !sLeagueName.equals('')  ">
            AND league_name LIKE CONCAT('%',#{sLeagueName},'%')
        </if>
        <if test="sYear != null and !sYear.equals('')">
            AND (a.play_sdate BETWEEN CONCAT(#{sYear}, '-01-01 00:00:00') AND CONCAT(#{sYear}, '-12-31 23:59:59') OR
            a.play_edate BETWEEN CONCAT(#{sYear}, '-01-01 00:00:00') AND CONCAT(#{sYear}, '-12-31 23:59:59'))
        </if>

        ORDER BY

        <if test="orderName != null and order != null ">
            <choose>
                <when test="orderName == 'key' ">
                    a.id
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'name' ">
                    a.name
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'address' ">
                    a.address
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>

                <!-- <otherwise>
                    ,id ASC ,name ASC
                </otherwise> -->
            </choose>
        </if>
        play_sdate DESC , a.league_id DESC
        <!-- a.league_id DESC	 -->

        LIMIT ${sRow}, ${eCount}
    </select>

    <select id="selectGetLeagueInfo" parameterType="hashmap" resultType="hashmap">
        SELECT
        a.league_id, a.area_name, a.league_name, a.league_name_origin, a.rank_type,
        DATE_FORMAT(a.play_sdate, '%Y%m%d') AS play_sdate, DATE_FORMAT(a.play_edate, '%Y%m%d') AS play_edate,
        DATE_FORMAT(a.play_sdate, '%Y.%m.%d') AS sdate, DATE_FORMAT(a.play_edate, '%Y.%m.%d') AS edate,
        DATE_FORMAT(a.play_sdate, '%Y-%m-%d') AS sdate1, DATE_FORMAT(a.play_edate, '%Y-%m-%d') AS edate1,
        DATE_FORMAT(SUBSTRING_INDEX(a.play_edate,' ',1 ), '%Y') AS lyears,
        a.play_flag,
        IFNULL(b.ltCnt, 0) AS ltCnt,
        league_info, league_prize
        FROM ${leagueInfoTB} a
        <!-- INNER JOIN -->
        LEFT JOIN
        (
        SELECT COUNT(*) AS ltCnt, league_id FROM ${leagueTeamTB} WHERE use_flag = 0 GROUP BY league_id
        )b
        ON a.league_id = b.league_id
        WHERE a.use_flag = 0
        AND a.league_id = #{leagueId}
    </select>

    <!-- 리그 기본정보 - 등록-->
    <insert id="insertLeagueInfo" parameterType="hashmap" >
        <![CDATA[
		INSERT INTO ${leagueInfoTB}
		(area_name, league_name, league_name_origin, play_sdate, play_edate, play_flag, rank_type, reg_date)
		VALUES
		( #{selArea}, #{leagueName}, #{leagueNameOrigin}, #{sdate}, #{edate}, #{pFlag}, #{rankType}, now());
		]]>

        <selectKey resultType="int" keyProperty="leagueInfoId" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>

    <!-- 리그 기본정보 - 수정-->
    <update id="updateLeagueInfo" parameterType="hashmap" >
        UPDATE ${leagueInfoTB}
        SET
            area_name = #{selArea},
            league_name = #{leagueName},
            league_name_origin = #{leagueNameOrigin},
            play_sdate = #{sdate},
            play_edate = #{edate},
            play_flag = #{pFlag},
            rank_type = #{rankType}
        WHERE league_id = #{leagueId}
    </update>

    <!-- 리그 기본정보 삭제  -->
    <delete id="deleteLeagueInfo" parameterType="hashmap" >
        DELETE FROM ${leagueInfoTB}
        WHERE league_id = #{leagueId}
    </delete>

    <select id="selectLeagueTeamList" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.league_team_id, a.nick_name, a.league_id, a.league_name,
            IFNULL(c.team_id, a.team_id) AS team_id ,
            c.team_name, c.team_type, c.emblem, c.addr
        FROM
            (
                SELECT  a.league_team_id, a.nick_name, a.team_id, a.league_id, b.league_name
                FROM ${leagueTeamTB} a
                         INNER JOIN ${leagueInfoTB} b
                                    ON a.league_id = b.league_id
                WHERE a.use_flag = 0
                  AND b.use_flag = 0
                  ANd a.league_id = #{leagueId}
            ) a

                LEFT JOIN
            (
                SELECT team_id, nick_name, team_name, team_type, emblem, addr, uage FROM Team WHERE uage = #{ageGroup}
            )c
            ON a.nick_name = c.nick_name

    </select>

    <!-- league team - 리그참가팀 정보 등록-->
    <insert id="insertLeagueTeam" parameterType="hashmap" >
        <if test="list.size != 0">
            INSERT INTO ${leagueTeamTB}
            (league_name, nick_name, team_id, league_id, reg_date)
            VALUES
            <foreach item="item" index="index" collection="list" separator="," >
                (
                #{item.leagueName}, #{item.nickName}, #{item.teamId}, #{item.leagueId}, now()
                )
            </foreach>
        </if>

        <selectKey resultType="int" keyProperty="leagueTeamId" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>

    <!-- 리그 참가팀 삭제  -->
    <delete id="deleteLeagueTeam" parameterType="hashmap" >
        DELETE FROM ${leagueTeamTB}
        WHERE league_id = #{leagueId}
    </delete>

    <!-- 리그 경기일정 리스트 -->
    <select id="selectLeagueMatchListCount" parameterType="hashmap" resultType="hashmap">
        SELECT COUNT(*) AS totalCount
        FROM ${leagueMatchTB}
        WHERE use_flag = 0
          AND league_id = #{leagueId}


    </select>

    <select id="selectLeagueMatchList" parameterType="hashmap" resultType="hashmap">
        <![CDATA[
		SELECT league_match_id, league_name,
		DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
		SUBSTRING_INDEX(match_date,' ',-1 ) AS ptime,
		match_date,
		place, home, away, home_score, away_score, match_type, reason, league_id, home_id, away_id
		FROM ${leagueMatchTB}
		WHERE use_flag = 0
		AND league_id = #{leagueId}
		]]>
        <if test="years != null and years != '' ">
            AND DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y') = CONCAT(SUBSTRING(match_date, 1, 3),#{years})
        </if>
        <if test="months != null and months != '' ">
            AND DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%c') = CONCAT(SUBSTRING(match_date, 1, 4),#{months})
        </if>
        ORDER BY pdate ASC, ptime ASC

        <!-- LIMIT ${msRow}, ${meCount} -->
    </select>

    <select id="selectLeagueMatchCalendar" parameterType="hashmap" resultType="hashmap">
        SELECT
            DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y') AS years,
            DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%c') AS months
        FROM ${leagueMatchTB} WHERE use_flag = 0
                                AND league_id = #{leagueId}
        ORDER BY months ASC
    </select>

    <select id="selectLeagueMatchListByHomeTeam" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.league_match_id, a.league_name,
            b.team_id, b.nick_name

        FROM ${leagueMatchTB} a
                 LEFT JOIN Team b
                           ON a.home = b.nick_name
        WHERE a.league_id = #{leagueId} AND b.uage = #{ageGroup}
    </select>

    <select id="selectLeagueMatchListByAwayTeam" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.league_match_id, a.league_name,
            b.team_id, b.nick_name

        FROM ${leagueMatchTB} a
                 LEFT JOIN Team b
                           ON a.away = b.nick_name
        WHERE a.league_id = #{leagueId} AND b.uage = #{ageGroup}
    </select>

    <!-- 리그 경기일정  정보 개별 등록-->
    <insert id="insertLeagueMatch" parameterType="hashmap" >
            INSERT INTO ${leagueMatchTB}
            (league_name, match_date, place, home, away, league_id, home_id, away_id,  reg_date)
            VALUES
            	<foreach collection="list" item="item" separator=",">
            	(
                #{item.leagueName}, #{item.matchDate}, #{item.place}, #{item.home}, #{item.away}, #{item.leagueId}, #{item.homeId}, #{item.awayId}, now()
                )
            	</foreach>
                

        <selectKey resultType="int" keyProperty="leagueMatchId" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>

    <!-- 리그 경기일정 삭제  -->
    <delete id="deleteLeagueMatch" parameterType="hashmap" >
        DELETE FROM ${leagueMatchTB}
        WHERE league_id = #{leagueId}

        <choose>
            <when test="months != null and !months.equals('')">
                AND DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%c') = #{months}
            </when>
        </choose>
    </delete>

    <delete id="deleteLeagueMatchOne" parameterType="hashmap">
        DELETE FROM ${leagueMatchTB}
        WHERE league_match_id = #{leagueMatchId}
    </delete>

    <update id="updateLeagueMatch" parameterType="hashmap" >
        UPDATE ${leagueMatchTB}
        SET
            match_date = #{matchDate},
            place = #{place},
            home = #{home},
            away = #{away},
            home_score = #{homeScore},
            away_score = #{awayScore},
            home_id = #{homeId},
            away_id = #{awayId},
            match_type = #{matchType},
            reason = #{reason}
        WHERE league_match_id = #{leagueMatchId}
          AND league_id = #{leagueId}
    </update>

    <update id="updateAllLeagueMatch" parameterType="hashmap" >
            UPDATE ${leagueMatchTB}
            SET
            match_date = #{matchDate},
            place = #{place},
            home = #{home},
            away = #{away},
            <if test="homeScore != '' and homeScore != null">
                home_score = #{homeScore},
            </if>
            <if test="awayScore != '' and awayScore != null">
                away_score = #{awayScore},
            </if>
            <if test="homeId != '-1' and homeId != null">
                home_id = #{homeId},
            </if>
            <if test="awayId != '-1' and awayId != null">
                away_id = #{awayId},
            </if>
            <if test="home != '미정' and home != '미정'">
                home = #{home},
            </if>
            <if test="away != '미정' and away != '미정'">
                away = #{away},
            </if>
            home = #{home},
            away = #{away},
            match_type = #{matchType},
            reason = #{reason}
            WHERE league_match_id = #{leagueMatchId}
            AND league_id = #{leagueId}
    </update>

    <!-- 리그 관리 - 리그결과 경기 리스트 -->
    <select id="selectLeagueMatchSchedule" parameterType="hashmap" resultType="hashmap">
        <![CDATA[
		SELECT a.league_match_id, a.league_name,
		SUBSTRING_INDEX(a.match_date,' ',2 ) AS playdate,
		DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
		SUBSTRING_INDEX(a.match_date,' ',-1 ) AS ptime,
		a.match_date, a.place,

		a.home_id, a.home,  a.home_score,
		b.emblem AS home_emblem, b.team_type AS home_type,
		a.away_id, a.away, a.away_score,
		c.emblem AS away_emblem, c.team_type AS away_type,
		a.match_type, a.reason, a.league_id,
		a.match_order, a.match_status,
		a.upd_flag
		FROM ${leagueMatchTB} a
		INNER JOIN Team b
		ON a.home_id = b.team_id
		INNER JOIN Team c
		ON a.away_id  = c.team_id
		WHERE a.use_flag = 0
		AND a.league_id = #{leagueId}
		]]>

        <if test="years != null and years != '' ">
            AND DATE_FORMAT(SUBSTRING_INDEX(a.match_date,' ',1 ), '%Y') = CONCAT(SUBSTRING(a.match_date, 1, 3),#{years})
        </if>
        <if test="months != null and months != '' ">
            AND DATE_FORMAT(SUBSTRING_INDEX(a.match_date,' ',1 ), '%Y%c') = CONCAT(SUBSTRING(a.match_date, 1, 4),#{months})
        </if>

        ORDER BY pdate ASC , ptime ASC

    </select>

    <select id="selectLeagueMgrList" parameterType="hashmap" resultType="hashmap">
        SELECT a.*, IFNULL(b.league_id, 0) AS noti_league_id
        FROM
        (
        SELECT a.league_id, a.area_name, a.league_name,
        DATE_FORMAT(a.play_sdate, '%Y.%m.%d') AS play_sdate,
        DATE_FORMAT(a.play_edate, '%Y.%m.%d') AS play_edate,
        a.play_flag ,
        CASE
        WHEN now() <![CDATA[>]]> a.play_edate THEN '종료'
        WHEN now() BETWEEN a.play_sdate AND a.play_edate THEN '진행중'
        WHEN now() <![CDATA[<]]> a.play_sdate THEN '예정'
        END AS progress,
        IFNULL(b.ltCnt, 0) AS ltCnt ,
        IFNULL(c.ptCnt, 0) AS ptCnt ,
        IFNULL(d.endPCnt, 0) AS endPCnt ,
        IFNULL((ptCnt - endPCnt), 0) AS remainCnt
        FROM ${leagueInfoTB} a
        LEFT JOIN
        (
        SELECT COUNT(*) AS ltCnt, league_id FROM ${leagueTeamTB} WHERE use_flag = 0 GROUP BY league_id
        )b
        ON a.league_id = b.league_id

        LEFT JOIN (
        SELECT COUNT(*) AS ptCnt, league_id FROM ${leagueMatchTB} WHERE use_flag = 0 GROUP BY league_id
        ) c
        ON a.league_id = c.league_id

        LEFT JOIN (
        SELECT COUNT(*) AS endPCnt, league_id FROM ${leagueMatchTB} WHERE use_flag = 0 GROUP BY league_id
        ) d
        ON a.league_id = d.league_id

        WHERE a.use_flag = 0

        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1')  ">
            AND a.area_name = #{sArea}
        </if>
        <if test="sLeagueName != null and !sLeagueName.equals('')  ">
            AND league_name LIKE CONCAT('%',#{sLeagueName},'%')
        </if>
        <if test="sYear != null and !sYear.equals('')">
            AND (a.play_sdate BETWEEN CONCAT(#{sYear}, '-01-01 00:00:00') AND CONCAT(#{sYear}, '-12-31 23:59:59') OR
            a.play_edate BETWEEN CONCAT(#{sYear}, '-01-01 00:00:00') AND CONCAT(#{sYear}, '-12-31 23:59:59'))
        </if>

        ) a LEFT JOIN
        (
        SELECT *
        FROM
        (
        SELECT league_id
        FROM ${leagueInfoTB}
        WHERE use_flag = 0
        ) a LEFT JOIN
        (
        SELECT league_id AS res_league_id, `result`
        FROM ${leagueResultTB}
        WHERE use_flag = 0
        ) b
        ON a.league_id = b.res_league_id
        WHERE `result` is null or `result` = ""
        GROUP BY league_id
        ) b
        ON a.league_id = b.league_id



        ORDER BY

        <if test="orderName != null and order != null ">
            <choose>
                <when test="orderName == 'key' ">
                    a.id
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'name' ">
                    a.name
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'address' ">
                    a.address
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>

                <!-- <otherwise>
                    ,id ASC ,name ASC
                </otherwise> -->
            </choose>
        </if>
        play_sdate DESC ,  a.league_id DESC
        <!-- a.league_id DESC	 -->
        LIMIT ${sRow}, ${eCount}
    </select>

    <!-- 리그 관리 - 리그결과 경기 순위 -->
    <select id="selectLeagueMatchRank" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.team_type, a.emblem, b.league_id,
            b.team_id, b.team, b.playTotalCnt, b.playCnt, b.point, b.losePoint, b.win, b.lose, b.draw, b.goalPoint, (b.win*3)+b.draw AS rankPoint
        FROM
            Team a
            INNER JOIN
                        (
                            SELECT
                                a.team_id , a.team,
                                SUM(a.playCnt) AS playTotalCnt,
                                SUM(a.matchType) AS playCnt,
                                SUM(a.point) AS point, SUM(a.losePoint) AS losePoint,
                                SUM(a.win) AS win,
                                SUM(a.lose) AS lose,
                                SUM(a.draw)AS draw,
                                SUM(a.point) - SUM(a.losePoint) AS goalPoint, a.league_id
                            FROM
                                (
                                    SELECT
                                        a.home_id AS team_id, a.home AS team,
                                        /*COUNT(a.league_match_id) AS playCnt,*/
                                        SUM(
                                            CASE
                                                WHEN DATE_FORMAT(SUBSTRING_INDEX(a.match_date, ' ', 1), '%Y-%m-%d') <![CDATA[<=]]> CURDATE() THEN 1
                                                ELSE 0
                                            END
                                        ) AS playCnt,
                                        SUM(a.match_type) AS matchType,
                                        SUM(a.home_score) AS point,
                                        SUM(a.away_score) AS losePoint,
                                        a.league_id, a.match_type,
                                        SUM(IFNULL(a.home_score <![CDATA[>]]> a.away_score, 1)) AS win,
                                        SUM(IFNULL(a.home_score <![CDATA[<]]> a.away_score, 1)) AS lose,
                                 /*SUM(IFNULL(a.home_score <![CDATA[=]]> a.away_score, 1)) AS draw*/
                                        SUM(
                                            CASE
                                                WHEN DATE(SUBSTRING_INDEX(a.match_date, ' ', 1)) <![CDATA[<=]]> CURDATE() THEN
                                                    CASE
                                                        WHEN a.away_score = a.home_score THEN 1
                                                        ELSE 0
                                                    END
                                                ELSE 0
                                            END
                                        ) AS draw
                                    FROM ${leagueMatchTB} a INNER JOIN ${leagueTeamTB} b ON a.home_id = b.team_id
                                    WHERE
                                        a.use_flag = 0
                                        AND b.use_flag = 0
                                        AND a.league_id = #{leagueId}
                                        AND b.league_id = #{leagueId}
                           /*AND DATE(SUBSTRING_INDEX(a.match_date, ' ', 1)) <![CDATA[<=]]>  CURDATE()*/
                                    GROUP BY team
                                    UNION ALL
                                    SELECT
                                        a.away_id AS team_id, a.away AS team,
                                        /*COUNT(a.league_match_id) AS playCnt,*/
                                        SUM(
                                            CASE
                                                WHEN DATE_FORMAT(SUBSTRING_INDEX(a.match_date, ' ', 1), '%Y-%m-%d') <![CDATA[<=]]> CURDATE() THEN 1
                                                ELSE 0
                                            END
                                        ) AS playCnt,
                                        SUM(a.match_type) AS matchType,
                                        SUM(a.away_score) AS point,
                                        SUM(a.home_score) AS losePoint,
                                        a.league_id, a.match_type,
                                        SUM(IFNULL(a.away_score <![CDATA[>]]> a.home_score, 1)) AS win,
                                        SUM(IFNULL(a.away_score <![CDATA[<]]> a.home_score, 1)) AS lose,
                                        /*SUM(IFNULL(a.away_score <![CDATA[=]]> a.home_score, 1)) AS draw*/
                                        SUM(
                                            CASE
                                                WHEN DATE(SUBSTRING_INDEX(a.match_date, ' ', 1)) <![CDATA[<=]]> CURDATE() THEN
                                                    CASE
                                                        WHEN a.away_score = a.home_score THEN 1
                                                        ELSE 0
                                                    END
                                                ELSE 0
                                            END
                                        ) AS draw
                 FROM ${leagueMatchTB} a INNER JOIN ${leagueTeamTB} b
                 ON a.away_id = b.team_id
                 WHERE a.use_flag = 0
                   AND b.use_flag = 0
                   AND a.league_id = #{leagueId}
                   AND b.league_id = #{leagueId}

                   /*AND DATE(SUBSTRING_INDEX(a.match_date, ' ', 1)) <![CDATA[<=]]>  CURDATE()*/

                 GROUP BY team

             ) a

        GROUP BY team

            ) b
        ON a.team_id = b.team_id

        ORDER BY rankPoint DESC, b.goalPoint DESC

    </select>

    <!-- 리그 관리 - 리그결과 최종 순위 -->
    <select id="selectLeagueFinalRank" parameterType="hashmap" resultType="hashmap">
        SELECT a.team_type, a.emblem, b.*
        FROM
            (
                SELECT team_id, team_type, emblem
                FROM Team
            ) a INNER JOIN
            (
                SELECT a.team, b.*
                FROM
                    (
                        SELECT team_id, nick_name AS team
                        FROM ${leagueTeamTB}
                        WHERE use_flag = 0
                          AND league_id = #{leagueId}
                    ) a LEFT JOIN
                    (
                        SELECT league_result_id, team_id, `result`, `rank`,
                               played AS playTotalCnt,
                               points + points_add AS rankPoint,
                               points_add AS rankPointAdd,
                               won AS win, draw AS draw, lost AS lose,
                               gf AS point, ga AS losePoint, gd as goalPoint,
                               mod_date
                        FROM ${leagueResultTB}
                        WHERE use_flag = 0
                          AND league_id = #{leagueId}
                    ) b
                    ON a.team_id = b.team_id
            ) b
            ON a.team_id = b.team_id
        /*WHERE b.playTotalCnt <![CDATA[>]]> 0*/

        ORDER BY b.rank ASC

    </select>

    <!-- 리그 최종순위 확정 - 등록 -->
    <insert id="insertLeagueFinalRank" parameterType="hashmap" >
        INSERT INTO ${leagueResultTB}(
        team_id,
        result,
        rank,
        league_id,
        played,
        points,
        points_add,
        won,
        draw,
        lost,
        gf,
        ga,
        gd,
        reg_date,
        mod_date
        )VALUES
        <foreach collection="list" item="item" separator=",">
            (
            #{item.teamId},
            #{item.result},
            #{item.rank},
            #{leagueId},
            #{item.played},
            #{item.points},
            #{item.pointsAdd},
            #{item.won},
            #{item.draw},
            #{item.lost},
            #{item.gf},
            #{item.ga},
            #{item.gd},
            now(),
            now()
            )
        </foreach>
    </insert>

    <!-- 리그 최종순위 확정 - 수정  -->
    <update id="updateLeagueFinalRank" parameterType="hashmap" >
        <foreach item="item" index="index" collection="list" separator=";" >
            UPDATE ${leagueResultTB}
            SET
            result = #{item.result},
            rank = #{item.rank},
            played = #{item.played},
            points = #{item.points},
            points_add = #{item.pointsAdd},
            won = #{item.won},
            draw = #{item.draw},
            lost = #{item.lost},
            gf = #{item.gf},
            ga = #{item.ga},
            gd = #{item.gd},
            mod_date = now()
            WHERE league_result_id = #{item.leagueResultId}\
        </foreach>
    </update>

    <!-- 리그 최종순위 확정 - 삭제  -->
    <delete id="deleteLeagueFinalRank" parameterType="hashmap" >
        <foreach item="item" index="index" collection="list" separator=";" >
            DELETE FROM ${leagueResultTB}
            WHERE league_result_id = #{item.leagueResultId}
        </foreach>
    </delete>

    <select id="selectListOfLeagueMatch" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.league_id
             ,A.league_name
             ,A.play_sdate
             ,A.play_edate
             ,B.league_match_id AS match_id
             ,B.place
             ,B.home_id
             ,B.away_id
             ,B.home
             ,B.away
             ,B.home_score
             ,B.away_score
             ,B.match_date
             ,C.emblem AS home_emblem
             ,D.emblem AS away_emblem
             , score_show_flag
             , #{ageGroup} AS ageGroup
        FROM
            ${leagueInfoTB} A
                INNER JOIN ${leagueMatchTB} B ON A.league_id = B.league_id
                INNER JOIN Team C ON B.home_id = C.team_id
                INNER JOIN Team D ON B.away_id = D.team_id
        WHERE
            DATE_FORMAT(B.match_date, '%Y-%m-%d 00:00:00') BETWEEN DATE_FORMAT(#{sdate}, '%Y-%m-%d 00:00:00') AND DATE_FORMAT(#{sdate}, '%Y-%m-%d 23:59:59')
    </select>

    <!-- Excel Insert 리그 참가팀 정보 - 일괄등록-->
    <insert id="insertLeagueTeamExcel" parameterType="hashmap" >
        INSERT INTO ${leagueTeamTB}(
        league_name,
        nick_name,
        league_id,
        reg_date
        ) VALUES
        (
        #{A},
        #{B},
        #{leagueId},
        now()
        )
    </insert>

    <!-- Excel Insert 리그 기본정보 - 일괄등록-->
    <insert id="insertLeagueInfoExcel" parameterType="hashmap" >
        INSERT INTO ${leagueInfoTB}(
        area_name,
        league_name,
        play_sdate,
        play_edate,
        play_flag,
        reg_date
        ) VALUES
        <foreach collection="excelContent" item="item" separator=",">
            (
            #{item.A},
            #{item.B},
            #{item.C},
            #{item.D},
            #{item.E},
            now()
            )
        </foreach>
    </insert>

    <!-- league team - 리그참가팀 리그 아이디 정보 수정-->
    <update id="updateLeagueTeamExcelByleagueId" parameterType="hashmap" >
		<![CDATA[
        UPDATE ${leagueTeamTB}
        SET
            league_id = #{leagueId}
        WHERE league_id = -1
        ]]>
	</update>

    <update id="updateLeagueTeamExcel_type1" parameterType="hashmap" >
        UPDATE ${leagueTeamTB}
        SET
            team_id = #{teamId}
        WHERE nick_name = #{nickName}
    </update>
    <update id="updateLeagueTeamExcel_type2" parameterType="hashmap" >
            UPDATE ${leagueTeamTB}
            SET
            team_id = #{team_id}
            WHERE nick_name = #{nick_name} AND league_id = #{leagueId}
    </update>

    <!-- Excel Insert 리그 경기일정 정보 - 일괄등록-->
    <insert id="insertLeagueMatchExcel" parameterType="hashmap" >
        INSERT INTO ${leagueMatchTB}(
        match_order,
        league_name,
        match_date,
        place,
        home,
        away,
        home_score,
        away_score,
        match_type,
        reason,
        league_id,
        reg_date
        )VALUES
            (
            #{A},
            #{B},
            #{C},
            #{D},
            #{E},
            #{F},
            #{G},
            #{H},
            #{I},
            #{J},
            #{leagueId},
            now()
            )
    </insert>

    <!-- league match - 리그 경기일정 리그 아이디 정보 수정-->
    <update id="updateLeagueMatchExcelByLeagueId" parameterType="hashmap" >
		<![CDATA[
        UPDATE ${leagueMatchTB}
        SET
            league_name = #{leagueName},
            league_id = #{leagueId}
        WHERE league_id = -1
        ]]>
	</update>

    <!-- 리그 경기일정 홈팅 정보 업데이트  -->
    <update id="updateLeagueMatchExcel_home" parameterType="hashmap" >
            UPDATE ${leagueMatchTB}
            SET
            home_id = #{team_id}
            WHERE league_match_id = #{league_match_id} AND home = #{nick_name} AND league_id = #{leagueId}
    </update>

    <!-- 리그 경기일정 어웨이팅 정보 업데이트  -->
    <update id="updateLeagueMatchExcel_away" parameterType="hashmap" >
            UPDATE ${leagueMatchTB}
            SET
            away_id = #{team_id}
            WHERE league_match_id = #{league_match_id} AND away = #{nick_name} AND league_id = #{leagueId}
    </update>

    <!-- 리그 관리 - 리그결과 경기 리스트 -->
    <select id="selectLeagueMatchListForMedia" parameterType="hashmap" resultType="hashmap">
		SELECT
            SUBSTRING_INDEX(a.match_date,' ',2 ) AS playdate,
            DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
            SUBSTRING_INDEX(a.match_date,' ',-1 ) AS ptime,
            a.match_date, a.place,
            a.home_id, a.home,  a.home_score,
            b.emblem AS home_emblem, b.team_type AS home_type,
            a.away_id, a.away, a.away_score,
            c.emblem AS away_emblem, c.team_type AS away_type,
            a.match_type, a.reason, a.league_id
		    , d.league_name, d.play_sdate, d.play_edate
		    , a.league_match_id, b.uage
		FROM ${childTB} a
		INNER JOIN Team b ON a.home_id = b.team_id
		INNER JOIN Team c ON a.away_id  = c.team_id
		INNER JOIN ${parentTB} d ON a.league_id = d.league_id
		WHERE
		    a.use_flag = 0
		    AND a.league_id = #{parentId}
          AND ${childKey} IN ${childId}
    </select>

    <select id="selectSearchLeagueInfoList" parameterType="hashmap" resultType="hashmap">
        SELECT
            league_id,
            league_name,
            DATE_FORMAT(play_sdate, '%Y.%m.%d') AS play_sdate,
            DATE_FORMAT(play_edate, '%Y.%m.%d') AS play_edate,
            play_flag
        FROM
            ${leagueInfoTB}
        WHERE
            1=1
            <if test="sLeagueName != null and sLeagueName != ''">
                AND league_name LIKE CONCAT('%',#{sLeagueName},'%')
            </if>
            <if test="sYear != null and sYear != ''">
                AND play_sdate BETWEEN CONCAT(#{sYear}, '-01-01 00:00:00') AND CONCAT(#{sYear}, '-12-31 23:59:59')
            </if>
    </select>

    <!-- 리그 관리 - 리그결과 경기 리스트 -->
    <select id="selectLeagueMatchForModifyResultRequest" parameterType="hashmap" resultType="hashmap">
        SELECT
            SUBSTRING_INDEX(a.match_date,' ',2 ) AS playdate,
            DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%Y%m%d') AS pdate,
            SUBSTRING_INDEX(a.match_date,' ',-1 ) AS ptime,
            a.match_date, a.place,
            a.home_id, a.home,  a.home_score,
            b.emblem AS home_emblem, b.team_type AS home_type,
            a.away_id, a.away, a.away_score,
            c.emblem AS away_emblem, c.team_type AS away_type,
            a.reason, a.league_id
                , d.league_name, d.play_sdate, d.play_edate
                , a.league_match_id, b.uage
            , d.league_name AS match_name
            , 'League' AS cup_league_category
            ,DATE_FORMAT(SUBSTRING_INDEX(match_date,' ',1 ), '%c') AS months
        FROM ${childTB} a
                 INNER JOIN Team b ON a.home_id = b.team_id
                 INNER JOIN Team c ON a.away_id  = c.team_id
                 INNER JOIN ${parentTB} d ON a.league_id = d.league_id
        WHERE
            a.use_flag = 0
          AND a.league_id = #{parentId}
          AND ${childKey} = ${childId}
    </select>

    <select id="selectGetLeagueInfoForMedia" parameterType="hashmap" resultType="hashmap">
        SELECT
        a.league_id, a.area_name, a.league_name,
        a.league_name AS match_name,
        DATE_FORMAT(a.play_sdate, '%Y%m%d') AS play_sdate, DATE_FORMAT(a.play_edate, '%Y%m%d') AS play_edate,
        DATE_FORMAT(a.play_sdate, '%Y.%m.%d') AS sdate, DATE_FORMAT(a.play_edate, '%Y.%m.%d') AS edate,
        DATE_FORMAT(a.play_sdate, '%Y-%m-%d') AS sdate1, DATE_FORMAT(a.play_edate, '%Y-%m-%d') AS edate1,
        DATE_FORMAT(SUBSTRING_INDEX(a.play_edate,' ',1 ), '%Y') AS lyears,
        a.play_flag
        ,LEFT(#{leagueInfoTB}, 3) AS uage
        FROM ${leagueInfoTB} a
        WHERE a.use_flag = 0
        AND a.league_id = #{leagueId}
    </select>

    <select id="selectLeagueMatchScheduleForExcel" parameterType="hashmap" resultType="hashmap">
		SELECT
		    a.league_name AS '1',
		    a.match_date AS '2',
            a.place AS '3',
		    a.home AS '4',
		    a.away AS '5',
		    a.home_score AS '6',
		    a.away_score AS '7',
		    a.match_type AS '8'
		FROM
            ${leagueMatchTB} a
		    INNER JOIN Team b ON a.home_id = b.team_id
		    INNER JOIN Team c ON a.away_id  = c.team_id
		WHERE
		    a.use_flag = 0
		    AND a.league_id = #{leagueId}
        ORDER BY
            match_date ASC
    </select>

    <update id="updateMatchInfo" parameterType="java.util.HashMap">
        update ${leagueMatchTB}
        set match_status = #{playData.status}
            , audience = #{playData.audience}
            , weather = #{playData.weather}
            , play_time = #{playData.playTime}
            , main_referee = #{playData.mainReferee}
            , sub_referee = #{playData.subReferee}
            , stand_by_referee = #{playData.standByReferee}
            , referee_evaluation = #{playData.refereeEvaluation}
            , game_supervisor = #{playData.gameSupervisor}
        where league_match_id = #{leagueMatchId}
    </update>

    <select id="selectMatchPlayData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select
            play_data_id, player_number, position, player_name, compete, goal, help, warning, gexit, pso, home_away_gbn, sel_can_gbn, match_id, player_id, reg_date
        from ${cupMatchPlayDataTB}
        where home_away_gbn = #{homeAwayGbn}
          and sel_can_gbn = #{selCanGbn}
          and match_id = #{matchId}
    </select>

    <select id="selectMatchChangeData" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select change_data_id, time, in_player_number, in_player_name, in_player_id, out_player_number, out_player_name, out_player_id, home_away_gbn, match_id, reg_date
        from ${cupMatchChangeDataTB}
        where home_away_gbn = #{homeAwayGbn}
          and match_id = #{matchId}
    </select>
    
    <select id="selectTeamNameForLeagueMatchCnt" parameterType="hashmap" resultType="hashmap">
        SELECT
			COUNT(1) AS leagueMatchCnt
        FROM ${leagueMatchTB}
        WHERE
        	(
        	home_id = #{teamId}
        	OR away_id = #{teamId}
        	)
        	AND match_date BETWEEN DATE_FORMAT('${startDate}', '%Y-%m-%d') AND DATE_FORMAT(NOW(), '%Y-%m-%d')
    </select>
    
    <select id="selectTeamNameForLeagueTeamCnt" parameterType="hashmap" resultType="hashmap">
        SELECT
			COUNT(1) AS leagueTeamCnt
        FROM ${leagueTeamTB}
        WHERE
        	team_id = #{teamId}
        	AND league_id IN (
        					SELECT 
        						league_id 
        					FROM ${leagueMatchTB} 
        					WHERE (home_id = #{teamId} OR away_id = #{teamId}) 
        					AND match_date BETWEEN DATE_FORMAT('${startDate}', '%Y-%m-%d') AND DATE_FORMAT(NOW(), '%Y-%m-%d')
        					GROUP BY league_id
        				  )
    </select>
    
    <update id="updateTeamNameForLeagueMatchHome" parameterType="hashmap">
    	UPDATE
    		${leagueMatchTB}
    	SET home = #{newNickName}
    	WHERE
    		home_id = #{teamId}
    		AND match_date BETWEEN DATE_FORMAT('${startDate}', '%Y-%m-%d') AND DATE_FORMAT(NOW(), '%Y-%m-%d')
    </update>
    
    <update id="updateTeamNameForLeagueMatchAway" parameterType="hashmap">
    	UPDATE
    		${leagueMatchTB}
    	SET away = #{newNickName}
    	WHERE
    		away_id = #{teamId}
    		AND match_date BETWEEN DATE_FORMAT('${startDate}', '%Y-%m-%d') AND DATE_FORMAT(NOW(), '%Y-%m-%d')
    </update>
    
    <update id="updateTeamNameForLeagueTeam" parameterType="hashmap">
    	UPDATE 
    		${leagueTeamTB}
    	SET nick_name = #{newNickName}
        WHERE
        	team_id = #{teamId}
        	AND league_id IN (
        					SELECT 
        						league_id 
        					FROM ${leagueMatchTB} 
        					WHERE (home_id = #{teamId} OR away_id = #{teamId}) 
        					AND match_date BETWEEN DATE_FORMAT('${startDate}', '%Y-%m-%d') AND DATE_FORMAT(NOW(), '%Y-%m-%d')
        					GROUP BY league_id
        				  )
    </update>
    
    <select id="selectLeagueMatchRankForWin" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.team_type, a.emblem, b.league_id,
            b.team_id, b.team, b.playTotalCnt, b.playCnt, b.point, b.losePoint, b.win, b.lose, b.draw, b.goalPoint, (b.win*3)+b.draw AS rankPoint
        FROM
            Team a
            INNER JOIN
                        (
                            SELECT
                                a.team_id , a.team,
                                SUM(a.playCnt) AS playTotalCnt,
                                SUM(a.matchType) AS playCnt,
                                SUM(a.point) AS point, SUM(a.losePoint) AS losePoint,
                                SUM(a.win) AS win,
                                SUM(a.lose) AS lose,
                                SUM(a.draw)AS draw,
                                SUM(a.point) - SUM(a.losePoint) AS goalPoint, a.league_id
                            FROM
                                (
                                    SELECT
                                        a.home_id AS team_id, a.home AS team,
                                        SUM(
                                            CASE
                                                WHEN DATE_FORMAT(SUBSTRING_INDEX(a.match_date, ' ', 1), '%Y-%m-%d') <![CDATA[<=]]> CURDATE() THEN 1
                                                ELSE 0
                                            END
                                        ) AS playCnt,
                                        SUM(a.match_type) AS matchType,
                                        SUM(a.home_score) AS point,
                                        SUM(a.away_score) AS losePoint,
                                        a.league_id, a.match_type,
                                        SUM(IFNULL(a.home_score <![CDATA[>]]> a.away_score, 1)) AS win,
                                        SUM(IFNULL(a.home_score <![CDATA[<]]> a.away_score, 1)) AS lose,
                                        SUM(
                                            CASE
                                                WHEN DATE(SUBSTRING_INDEX(a.match_date, ' ', 1)) <![CDATA[<=]]> CURDATE() THEN
                                                    CASE
                                                        WHEN a.away_score = a.home_score THEN 1
                                                        ELSE 0
                                                    END
                                                ELSE 0
                                            END
                                        ) AS draw
                                    FROM ${leagueMatchTB} a INNER JOIN ${leagueTeamTB} b ON a.home_id = b.team_id
                                    WHERE
                                        a.use_flag = 0
                                        AND b.use_flag = 0
                                        AND a.league_id = #{leagueId}
                                        AND b.league_id = #{leagueId}
                                        AND (
											a.home_id IN (
											<foreach collection="list" item="item" separator=", ">
											#{item}
											</foreach>
											) 
											AND a.away_id IN (
											<foreach collection="list" item="item" separator=", ">
											#{item}
											</foreach>
											)
										)
                                    GROUP BY team
                                    UNION ALL
                                    SELECT
                                        a.away_id AS team_id, a.away AS team,
                                        SUM(
                                            CASE
                                                WHEN DATE_FORMAT(SUBSTRING_INDEX(a.match_date, ' ', 1), '%Y-%m-%d') <![CDATA[<=]]> CURDATE() THEN 1
                                                ELSE 0
                                            END
                                        ) AS playCnt,
                                        SUM(a.match_type) AS matchType,
                                        SUM(a.away_score) AS point,
                                        SUM(a.home_score) AS losePoint,
                                        a.league_id, a.match_type,
                                        SUM(IFNULL(a.away_score <![CDATA[>]]> a.home_score, 1)) AS win,
                                        SUM(IFNULL(a.away_score <![CDATA[<]]> a.home_score, 1)) AS lose,
                                        SUM(
                                            CASE
                                                WHEN DATE(SUBSTRING_INDEX(a.match_date, ' ', 1)) <![CDATA[<=]]> CURDATE() THEN
                                                    CASE
                                                        WHEN a.away_score = a.home_score THEN 1
                                                        ELSE 0
                                                    END
                                                ELSE 0
                                            END
                                        ) AS draw
                 FROM ${leagueMatchTB} a INNER JOIN ${leagueTeamTB} b
                 ON a.away_id = b.team_id
                 WHERE a.use_flag = 0
                   AND b.use_flag = 0
                   AND a.league_id = #{leagueId}
                   AND b.league_id = #{leagueId}
                   AND (
						a.home_id IN (
						<foreach collection="list" item="item" separator=", ">
						#{item}
						</foreach>
						) 
						AND a.away_id IN (
						<foreach collection="list" item="item" separator=", ">
						#{item}
						</foreach>
						)
					)
                 GROUP BY team
             ) a
        GROUP BY team
            ) b
        ON a.team_id = b.team_id
        <!-- <if test="rpoint != null and rpoint != ''">
		WHERE (b.win*3)+b.draw = #{rpoint}
		</if> -->
        ORDER BY 
		rankPoint DESC,
        b.goalPoint DESC
    </select>

    <select id="selectGetLeagueInfoForWin" parameterType="hashmap" resultType="hashmap">
        SELECT
        a.league_id, a.area_name, a.league_name, a.league_name_origin, a.rank_type,
        DATE_FORMAT(a.play_sdate, '%Y%m%d') AS play_sdate, DATE_FORMAT(a.play_edate, '%Y%m%d') AS play_edate,
        DATE_FORMAT(a.play_sdate, '%Y.%m.%d') AS sdate, DATE_FORMAT(a.play_edate, '%Y.%m.%d') AS edate,
        DATE_FORMAT(a.play_sdate, '%Y-%m-%d') AS sdate1, DATE_FORMAT(a.play_edate, '%Y-%m-%d') AS edate1,
        DATE_FORMAT(SUBSTRING_INDEX(a.play_edate,' ',1 ), '%Y') AS lyears,
        a.play_flag,
        IFNULL(b.ltCnt, 0) AS ltCnt
        FROM ${leagueInfoTB} a
        <!-- INNER JOIN -->
        LEFT JOIN
        (
        SELECT COUNT(*) AS ltCnt, league_id FROM ${leagueTeamTB} WHERE use_flag = 0 GROUP BY league_id
        )b
        ON a.league_id = b.league_id
        WHERE a.use_flag = 0
        AND a.league_id = #{leagueId}
    </select>

    <update id="updateMatchScoreShowFlag" parameterType="hashmap">
        UPDATE
            ${leagueMatchTB}
        SET
        score_show_flag = #{scoreShowFlag}
        WHERE
            league_match_id = #{matchId}
    </update>

    <select id="selectSearchLeagueForChampion" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.league_id,
            A.league_name,
            #{ageGroup} AS uage,
            DATE_FORMAT(play_sdate, '%Y-%m-%d') AS play_sdate,
            DATE_FORMAT(play_edate, '%Y-%m-%d') AS play_edate,
            played,
            won AS win,
            draw,
            lost AS lose,
            gf,
            ga,
            C.team_id,
            C.emblem,
            C.nick_name,
            DATE_FORMAT(A.play_sdate, '%Y') AS year
        FROM
            ${leagueInfoTB} A
            INNER JOIN ${leagueResultTB} B ON A.league_id = B.league_id
            INNER JOIN Team C ON B.team_id = C.team_id
        WHERE
        A.play_flag = 0
        AND A.use_flag = 0
        AND B.result = '1위'
        <if test="sLeagueName != null and sLeagueName != ''">
            AND A.league_name LIKE CONCAT('%', #{sLeagueName}, '%')
        </if>
        <if test="sLeagueYear != null and sLeagueYear != ''">
            AND (DATE_FORMAT(A.play_sdate, '%Y-%m-%d') BETWEEN CONCAT(#{sLeagueYear}, '-01-01') AND CONCAT(#{sLeagueYear}, '-12-31') AND A.play_edate BETWEEN CONCAT(#{sLeagueYear}, '-01-01') AND CONCAT(#{sLeagueYear}, '-12-31'))
        </if>
    </select>

    <select id="selectGetLeagueChampions" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.champion_id,
            A.foreign_id,
            A.year,
            A.uage,
            B.league_name,
            A.win,
            A.lose,
            A.draw,
            A.gf,
            A.ga,
            C.emblem,
            C.team_id,
            C.team_name,
            C.nick_name
        FROM
            Champion A
            INNER JOIN ${leagueInfoTB} B ON A.foreign_type = 'league' AND A.foreign_id = B.league_id
            INNER JOIN Team C ON A.team_id = C.team_id
        WHERE
            A.info_id = #{leagueId}
          AND A.use_flag = 0
        ORDER BY
            A.year DESC
    </select>

    <update id="updateLeaguePrize" parameterType="hashmap" >
        UPDATE ${leagueInfoTB}
        SET
            league_info = #{lInfo},
            league_prize = #{lPrize}
        WHERE league_id = #{leagueId}
	</update>

    <update id="updateLeagueResultForChampion" parameterType="hashmap" >
        <foreach collection="list" item="item" separator=";">
            UPDATE
            Champion
            SET use_flag = '1'
            WHERE
            champion_id = #{item.championId}
        </foreach>
    </update>

    <insert id="insertLeagueResultForChampion" parameterType="hashmap" >
        INSERT INTO Champion (
        info_id,
        year,
        uage,
        foreign_id,
        foreign_type,
        nick_name,
        team_id,
        played,
        win,
        draw,
        lose,
        gf,
        ga
        )VALUES
            (
            #{infoId},
            #{year},
            #{ageGroup},
            #{foreignId},
            'league',
            #{nickName},
            #{teamId},
            #{played},
            #{win},
            #{draw},
            #{lose},
            #{gf},
            #{ga}
            )
    </insert>

    <select id="selectProgressLeagueInfo" parameterType="hashmap" resultType="hashmap">
        SELECT
            #{ageGroup} AS ageGroup,
            A.league_id,
            A.league_name,
            -- cup_team,
            DATE_FORMAT(play_sdate, '%Y.%m.%d') AS play_sdate,
            DATE_FORMAT(play_edate, '%Y.%m.%d') AS play_edate,
            play_flag,
            A.show_flag,
            B.cnt
        FROM
            ${leagueInfoTB} A
            LEFT JOIN (
                        SELECT
                            league_id,
                            COUNT(1) AS cnt
                        FROM
                            ${leagueTeamTB}
                        GROUP BY
                            league_id
            ) B ON A.league_id = B.league_id
        WHERE
            use_flag = 0
            <if test="sdate != null and sdate != ''">
            AND #{sdate} BETWEEN play_sdate AND play_edate
            </if>
    </select>

    <update id="updateShowFlagProgressLeague" parameterType="hashmap">
        UPDATE
            ${leagueInfoTB}
        SET
            show_flag = #{showFlag}
        WHERE
            league_id = #{leagueId}
    </update>
    
    <select id="selectSearchMatchOrderForPlayDataCraw" parameterType="java.util.HashMap" resultType="java.util.HashMap">
        select
            match_order
            , league_match_id as match_id
        from
            ${matchTB}
        where
			league_id = #{leagueId}
			<if test="sDate != null and sDate != ''">
				and SUBSTRING_INDEX(match_date , ' ', 1) = DATE_FORMAT(#{sDate}, '%Y-%m-%d')
			</if>
    </select>
    
    <select id="selectLeagueMatchListCraw" parameterType="java.util.HashMap" resultType="kr.co.nextplayer.base.backend.dto.joinkfaCraw.MatchDataDto">
        select
            match_order
			,league_match_id as match_id
			,home
			,away 
			,home_id
			,away_id
			,home_score as home_bf_score
			,away_score as away_bf_score
			,match_status
			,upd_flag
        from
            ${matchTB}
        where
            league_id = #{leagueId}
		and use_flag = 0
    </select>
    
        <update id="updateLeagueMatchScore" parameterType="hashmap" >
        UPDATE ${leagueMatchTB}
        SET
            home_score = #{homeScore},
            away_score = #{awayScore},
            <!-- match_status = #{matchStatus}, -->
            upd_flag = #{updFlag}
        WHERE league_match_id = #{leagueMatchId}
          AND league_id = #{leagueId}
    </update>

</mapper>