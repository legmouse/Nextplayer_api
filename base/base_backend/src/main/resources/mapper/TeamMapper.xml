<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.co.nextplayer.base.backend.mapper.TeamMapper">

    <select id="selectSearchTeamList" parameterType="hashmap" resultType="hashmap">
        SELECT
            team_id, uage, area_name, team_type, team_name, nick_name, addr, emblem, use_flag
        FROM Team
        WHERE uage REGEXP (#{ageGroup})
          AND nick_name REGEXP (#{nickName})
        ORDER BY team_id ASC

    </select>

    <select id="selectSearchTeamList2" parameterType="hashmap" resultType="hashmap">
        SELECT team_id, nick_name
        FROM Team
        WHERE uage = #{ageGroup}
          AND nick_name LIKE CONCAT('%', #{nickName}, '%')
        ORDER BY team_name ASC

    </select>

    <select id="selectSearchTeam" parameterType="hashmap" resultType="hashmap">
        SELECT
            team_id
        FROM
            Team
        WHERE
            uage = #{ageGroup}
            AND team_name = #{teamName}
    </select>

    <!-- 학원.클럽.유스 정보  -->
    <select id="selectTeamListCount" parameterType="hashmap" resultType="hashmap">
        SELECT
            COUNT(*) AS totalCount
        FROM
            Team
        WHERE
            uage REGEXP (#{ageGroup})
            <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1') ">
            AND area_name = #{sArea}
            </if>
            <if test="sTeamType != null and !sTeamType.equals('') and !sTeamType.equals('-1') ">
            AND team_type = #{sTeamType}
            </if>
            <if test="sNickName != null and !sNickName.equals('') ">
            AND nick_name REGEXP (#{sNickName})
            </if>

    </select>

    <select id="selectTeamList" parameterType="hashmap" resultType="hashmap">
        SELECT
        t.team_id, t.uage, t.area_name, t.team_type, t.team_name, t.nick_name, t.addr, t.emblem, t.use_flag , t.pId, t.pId_name
        FROM Team t
        WHERE t.uage REGEXP (#{ageGroup})

        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1') ">
            AND t.area_name = #{sArea}
        </if>
        <if test="sTeamType != null and !sTeamType.equals('') and !sTeamType.equals('-1') ">
            AND t.team_type = #{sTeamType}
        </if>
        <if test="sNickName != null and !sNickName.equals('') ">
            AND t.nick_name REGEXP (#{sNickName})
        </if>
        <if test="useFlag != null and !useFlag.equals('') and !useFlag.equals('-1') ">
            AND t.use_flag = #{useFlag}
        </if>
        <if test="includeFlag != null and !includeFlag.equals('') and !includeFlag.equals('-1') ">
			AND (SELECT COUNT(1) FROM joinkfa_team jkt where jkt.np_team_group_id = t.team_group_id AND jkt.np_team_id REGEXP (t.team_id)) = #{includeFlag}
		</if>
        ORDER BY
        t.use_flag ASC,
        <if test="orderName != null and order != null ">
            <choose>
                <when test="orderName == 'key' ">
                    t.id
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'name' ">
                    t.name
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'address' ">
                    t.address
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>

                <!-- <otherwise>
                    ,id ASC ,name ASC
                </otherwise> -->
            </choose>
        </if>
        <!-- 		team_id ASC -->
        t.team_name ASC
        <if test="(eCount != null and eCount != '') and (sRow != null and sRow != '')">
        LIMIT ${sRow}, ${eCount}
        </if>

    </select>

    <!-- 학원/클럽 - 등록-->
    <insert id="insertTeam" parameterType="hashmap">
        INSERT INTO Team
        (uage, area_name, team_type, team_name, nick_name, addr, emblem,
        <if test="pId != null and !pId.equals('') ">pId, pId_name,</if> reg_date)
        VALUES
        (#{ageGroup}, #{selArea}, #{teamType}, #{teamName}, #{nickName},  #{addr}, #{emblemFileParam},
        <if test="pId != null and !pId.equals('') ">#{pId}, #{pIdName},</if> now());

        <selectKey resultType="int" keyProperty="teamId" order="AFTER">
            SELECT LAST_INSERT_ID();
        </selectKey>
    </insert>

    <!-- 학원/클럽 - 수정-->
    <update id="updateTeam" parameterType="hashmap">
        UPDATE Team
        SET
        <choose>
            <when test="emblemFlag != null and !emblemFlag.equals('') and emblemFlag > 0 ">
                emblem = #{emblemFileParam}
            </when>
            <otherwise>

                <if test="pId != null and !pId.equals('') ">
                    pId_name = #{pIdName},
                    pId = #{pId},
                </if>

                area_name = #{selArea},
                team_type = #{teamType},
                team_name = #{teamName},
                nick_name = #{nickName},
                addr = #{addr},
                emblem = #{emblemFileParam},
                use_flag = #{useFlag}
            </otherwise>
        </choose>
        WHERE team_id = #{teamId}
    </update>

    <!-- 학원/클럽 - 연령별 삭제  -->
    <delete id="deleteTeam" parameterType="hashmap">
        <if test="sFlag != null and !sFlag.equals('') ">
            DELETE FROM Team
            <choose>
                <when test="sFlag == 2 ">
                    WHERE team_id = #{teamId};
                </when>
                <when test="sFlag == 10 ">
                    WHERE uage REGEXP #{ageGroup};
                </when>
            </choose>
        </if>
    </delete>

    <!-- Excel Insert 학원.클럽.유스 - 일괄등록-->
    <insert id="insertTeamExcel" parameterType="hashmap" >
        INSERT INTO Team(
        uage,
        area_name,
        team_type,
        team_name,
        nick_name,
        addr,
        phone,
        fax,
        emblem,
        use_flag,
        reg_date
        ) VALUES
            (
            #{A},
            #{B},
            #{C},
            #{D},
            #{E},
            #{F},
            #{G},
            #{H},
            #{I},
            #{J},
            now()
            )
    </insert>

    <!-- 클럽 관리  -->
    <select id="selectTeamMgrListCount" parameterType="hashmap" resultType="hashmap">
        SELECT COUNT(*) AS totalCount
        FROM Team t
        WHERE t.uage REGEXP (#{ageGroup})

        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1') ">
            AND t.area_name = #{sArea}
        </if>
        <if test="sTeamType != null and !sTeamType.equals('') and !sTeamType.equals('-1') ">
            AND t.team_type = #{sTeamType}
        </if>
        <if test="sNickName != null and !sNickName.equals('') ">
            AND t.nick_name REGEXP (#{sNickName})
        </if>
        <if test="useFlag != null and !useFlag.equals('') and !useFlag.equals('-1') ">
            AND t.use_flag = #{useFlag}
        </if>
        <if test="includeFlag != null and !includeFlag.equals('') and !includeFlag.equals('-1') ">
			AND (SELECT COUNT(1) FROM joinkfa_team jkt where jkt.np_team_group_id = t.team_group_id AND jkt.np_team_id REGEXP (t.team_id)) = #{includeFlag}
		</if>
    </select>

    <!--<select id="selectTeamMgrList" parameterType="hashmap" resultType="hashmap">-->
    <select id="selectTeamMgrList" parameterType="hashmap" resultType="hashmap">
        SELECT
            a.team_id,
            a.uage,
            a.area_name AS area_name,
            a.team_type,
            a.nick_name,
            a.emblem,
            a.use_flag,
            a.include_flag,
            IFNULL(b.league_name, '-') AS league_name,
            IFNULL(b.l_result, '-') AS l_result,
            b.l_rank,
            IFNULL(b.l_points, '-') AS l_points,
            b.play_sdate AS league_sdate,
            b.play_edate AS league_edate,
            IFNULL(a.cup_name, '-') AS cup_name,
            IFNULL(a.c_result, '-') AS c_result,
            cast(
                IF(right(c_result, 1) = '강', SUBSTRING_INDEX(c_result, '강', 1),
                IF(c_result = '우승', 1,
                    IF(c_result = '준우승', 2,
                        IF(c_result = '예선', 999,
                            IF(c_result = '본선', 888, '') ) ) ) )
                as unsigned)	 AS c_rank,
            a.play_sdate AS cup_sdate,
            a.play_edate AS cup_edate,
            a.cup_type,
            IFNULL( TRUNCATE( ( SUM(IFNULL(a.c_won, 0) + IFNULL(b.l_won, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) )*100 , 1 ), 0) AS avgWon,
            SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) AS played,
            SUM(IFNULL(a.c_won, 0) + IFNULL(b.l_won, 0)) AS won,
            SUM(IFNULL(a.c_draw, 0) + IFNULL(b.l_draw, 0)) AS draw,
            SUM(IFNULL(a.c_lost, 0) + IFNULL(b.l_lost, 0)) AS lost,
            SUM(IFNULL(a.c_gf, 0) + IFNULL(b.l_gf, 0)) AS gf,
            SUM(IFNULL(a.c_ga, 0) + IFNULL(b.l_ga, 0)) AS ga,
            IFNULL(TRUNCATE( SUM(IFNULL(a.c_gf, 0) + IFNULL(b.l_gf, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) , 1 ), 0) AS avgGf,
            IFNULL(TRUNCATE( SUM(IFNULL(a.c_ga, 0) + IFNULL(b.l_ga, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) , 1 ), 0) AS avgGa,
            IFNULL(TRUNCATE(SUM(IFNULL(a.c_points, 0) + IFNULL(b.l_points, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)), 1), 0) AS avg_point
        FROM
            (
                SELECT
                    a.team_id, a.area_name, a.team_type, a.nick_name, a.emblem, a.uage, a.use_flag, a.include_flag,
                    b.c_team_id, b.cup_id,
                    /*b.c_result,*/
                    CASE
                        WHEN b.c_end_flag = '1' THEN b.c_result
                        ELSE '진행중'
                    END AS c_result,
                    b.sub_rank, b.main_rank,
                    b.cup_name, b.play_sdate, b.play_edate, b.cup_type,
                    SUM(c_played) AS c_played,
                    SUM(c_won) AS c_won,
                    SUM(c_draw) AS c_draw,
                    SUM(c_lost) AS c_lost,
                    SUM(c_gf) AS c_gf,
                    SUM(c_ga) AS c_ga,
                    SUM(c_gd) AS c_gd,
                    SUM(c_points) AS c_points
                FROM
                    (
                        SELECT
                            t.team_id, t.uage, t.area_name, t.team_type, t.team_name, t.nick_name, t.emblem, use_flag,
                            (SELECT COUNT(1) FROM joinkfa_team jkt where jkt.np_team_group_id = t.team_group_id AND jkt.np_team_id REGEXP (t.team_id)) AS include_flag
                        FROM Team t
                        WHERE t.uage REGEXP (#{ageGroup})
                        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1') ">
                            AND t.area_name = #{sArea}
                        </if>
                        <if test="sTeamType != null and !sTeamType.equals('') and !sTeamType.equals('-1') ">
                            AND t.team_type = #{sTeamType}
                        </if>
                        <if test="sNickName != null and !sNickName.equals('') ">
                            AND t.nick_name REGEXP (#{sNickName})
                        </if>
                        <if test="useFlag != null and !useFlag.equals('') and !useFlag.equals('-1') ">
                            AND t.use_flag = #{useFlag}
                        </if>
                        <if test="includeFlag != null and !includeFlag.equals('') and !includeFlag.equals('-1') ">
                            AND (SELECT COUNT(1) FROM joinkfa_team jkt where jkt.np_team_group_id = t.team_group_id AND jkt.np_team_id REGEXP (t.team_id)) = #{includeFlag}
                        </if>
                    ) a
                    LEFT JOIN
                            (
                                SELECT
                                    b.cup_name, b.play_sdate, b.play_edate, b.cup_type, a.*
                                    , b.c_end_flag
                                FROM
                                    (
                                    SELECT
                                        team_id AS c_team_id, cup_id,`result` AS c_result,sub_rank,main_rank,
                                        SUM(played1 + played2 + played3) AS c_played,
                                        SUM(won1 + won2 + won3) AS c_won,
                                        SUM(draw1 + draw2 + draw3) AS c_draw,
                                        SUM(lost1 + lost2 + lost3) AS c_lost,
                                        SUM(gf1 + gf2 + gf3) AS c_gf,
                                        SUM(ga1 + ga2 + ga3) AS c_ga,
                                        SUM(gd1 + gd2 + gd3) AS c_gd,
                                        SUM(points1 + points2 + points3) AS c_points,
                                        reg_date AS c_reg_date,mod_date1 AS c_mod_date1,mod_date2 AS c_mod_date2,mod_date3 AS c_mod_date3
                                    FROM ${cupResultTB}
                                    WHERE use_flag = 0
                                    GROUP BY cup_id, team_id
                                    ) a
                                    INNER JOIN
                                                (
                                                    SELECT
                                                        cup_id, cup_name, play_sdate, play_edate, cup_type
                                                        , CASE
                                                            WHEN play_edate > NOW() THEN '0'
                                                            ELSE '1'
                                                        END AS c_end_flag
                                                    FROM ${cupInfoTB}
                                                    WHERE
                                                        use_flag = 0
                                                        AND play_flag = 0
                                                        <choose>
                                                            <when test="sYear != null and sYear != '' ">
                                                                AND play_sdate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                                                                AND play_sdate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
                                                                AND play_edate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                                                                AND play_edate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
                                                            </when>
                                                            <otherwise>
                                                                AND play_sdate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                                                                AND play_sdate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
                                                                AND play_edate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                                                                AND play_edate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
                                                            </otherwise>
                                                        </choose>
                                                ) b ON a.cup_id = b.cup_id
                                ORDER BY b.play_edate DESC
                            ) b ON a.team_id = b.c_team_id
                GROUP BY a.team_id
            ) a
            LEFT JOIN
                    (
                        SELECT
                            a.l_team_id, b.league_name, b.play_sdate, b.play_edate,
                            a.league_id,
                            /*a.l_result,*/
                            CASE
                                WHEN b.l_end_flag = '1' THEN a.l_result
                                ELSE '진행중'
                            END AS l_result,
                            a.l_rank, a.l_points,
                            SUM(a.l_played) AS l_played,
                            SUM(a.l_won) AS l_won,
                            SUM(a.l_draw) AS l_draw,
                            SUM(a.l_lost) AS l_lost,
                            SUM(a.l_gf) AS l_gf,
                            SUM(a.l_ga) AS l_ga,
                            SUM(a.l_gd) AS l_gd,
                            l_reg_date, l_mod_date
                        FROM
                            (
                                SELECT
                                    team_id as l_team_id, league_id,
                                    `result` AS l_result,
                                    `rank` AS l_rank,
                                    SUM( points + points_add ) AS l_points, played AS l_played,
                                    won AS l_won,draw AS l_draw,lost AS l_lost,gf AS l_gf,ga AS l_ga,gd AS l_gd,
                                    reg_date AS l_reg_date,mod_date AS l_mod_date
                                FROM ${leagueResultTB}
                                WHERE use_flag = 0
                                GROUP BY league_id, team_id
                                ORDER By league_id DESC
                            ) a
                            INNER JOIN
                                        (
                                            SELECT
                                                league_id, league_name, play_sdate, play_edate
                                                ,CASE
                                                    WHEN play_edate > NOW() THEN '0'
                                                    ELSE '1'
                                                END AS l_end_flag
                                            FROM ${leagueInfoTB}
                                            WHERE
                                                use_flag = 0
                                                AND play_flag = 0
                                                <choose>
                                                    <when test="sYear != null and sYear != '' ">
                                                        AND play_sdate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                                                        AND play_sdate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
                                                        AND play_edate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                                                        AND play_edate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
                                                    </when>
                                                    <otherwise>
                                                        AND play_sdate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                                                        AND play_sdate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
                                                        AND play_edate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                                                        AND play_edate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
                                                    </otherwise>
                                                </choose>
                                        ) b ON a.league_id = b.league_id
                        GROUP BY a.l_team_id
                        ORDER BY b.play_edate DESC
                    ) b ON a.team_id = b.l_team_id
        GROUP BY a.team_id
        ORDER BY

        <if test="orderName != null and order != null ">
            <choose>
                <when test="orderName == 'nick_name' ">
                    nick_name
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'leagueName' ">
                    ISNULL(league_name) ASC, league_name
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'l_rank' ">
                    ISNULL(l_rank) ASC, l_rank
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'l_points' ">
                    ISNULL(l_points) ASC, l_points
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'cupName' ">
                    ISNULL(cup_name) ASC, cup_name
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'c_result' ">
                    ISNULL(c_result) ASC, c_rank
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'avgWon' ">
                    avgWon
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'played' ">
                    played
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'won' ">
                    won
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'draw' ">
                    draw
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'lost' ">
                    lost
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'gf' ">
                    gf
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'ga' ">
                    ga
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'avgGf' ">
                    avgGf
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'avgGa' ">
                    avgGa
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'avgPoint'">
                    avg_point
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>

            </choose>
        </if>
        won DESC, gf DESC

        LIMIT ${sRow}, ${eCount}
    </select>

    <!-- 학원클럽 - 요약정보 - 팀정보 상세 -->
    <select id="selectTeamInfo" parameterType="hashmap" resultType="hashmap">
        SELECT 
        	t.team_id, 
        	t.uage, 
        	t.area_name, 
        	t.team_type, 
        	t.team_name, 
        	t.nick_name, 
        	t.emblem, 
        	t.addr , 
        	t.pId, 
        	t.pId_name,
        	t.team_group_id,
        	t.use_flag,
        	tg.original_group_name
        FROM 
        	Team t
        	LEFT JOIN team_group tg ON t.team_group_id = tg.team_group_id
        WHERE t.team_id = #{teamId}

    </select>

    <!-- 학원클럽 - 요약정보 - 연도별 평균 득/실점 -->
    <select id="selectTeamAvgGoal" parameterType="hashmap" resultType="hashmap">
        SELECT a.team_id, a.play_year,
               SUM(played) AS played,
               SUM(gf) AS gf,
               SUM(ga) AS ga,

               TRUNCATE(SUM(IFNULL(gf, 0)) / SUM(IFNULL(played, 0)), 1) AS avg_gf,
               TRUNCATE(SUM(IFNULL(ga, 0)) / SUM(IFNULL(played, 0)), 1) AS avg_ga

        FROM
            (

                SELECT team_id, DATE_FORMAT( play_sdate, '%Y') AS play_year,
                       SUM(played1 + played2 + played3) AS played,
                       SUM(gf1 + gf2 + gf3) AS gf,
                       SUM(ga1 + ga2 + ga3) AS ga
                FROM
                    (
                        SELECT cup_id, play_sdate
                        FROM ${cupInfoTB}
                        WHERE use_flag = 0
                    ) a INNER JOIN
                    (
                        SELECT team_id,cup_id,played1,won1,draw1,lost1,gf1,ga1,played2,won2,draw2,lost2,gf2,ga2,played3,won3,draw3,lost3,gf3,ga3
                        FROM ${cupResultTB}
                        WHERE use_flag = 0
                          AND team_id = #{teamId}
                    ) b
                    ON a.cup_id = b.cup_id
                GROUP BY DATE_FORMAT( play_sdate, '%Y')

                UNION

                SELECT team_id, DATE_FORMAT( play_sdate, '%Y') AS play_year,
                       SUM(played) AS played,
                       SUM(gf) AS gf,
                       SUM(ga) AS ga
                FROM
                    (
                        SELECT league_id, play_sdate
                        FROM ${leagueInfoTB}
                        WHERE use_flag = 0
                    ) a INNER JOIN
                    (
                        SELECT team_id,league_id,played,gf,ga
                        FROM ${leagueResultTB}
                        WHERE use_flag = 0
                          AND team_id = #{teamId}
                    ) b
                    ON a.league_id = b.league_id
                GROUP BY DATE_FORMAT( play_sdate, '%Y')

            ) a
        GROUP BY play_year
        ORDER BY play_year ASC

    </select>

    <select id="selectTeamListForMedia" parameterType="hashmap" resultType="hashmap">
        SELECT
            team_id
            , uage
            , area_name
            , team_type
            , team_name
            , nick_name
            , addr
            , emblem
            , use_flag
        FROM
            Team
        WHERE
            team_id IN ${childId}
    </select>

    <select id="selectTeamGroupListCount" parameterType="hashmap" resultType="_int">
        SELECT
            COUNT(1)
        FROM
            Team_Group
        WHERE
            1=1
            <if test="sKeyword != null and !sKeyword.equals('') ">
                AND group_name LIKE CONCAT('%', #{sKeyword}, '%')
            </if>
    </select>

    <select id="selectTeamGroupList" parameterType="hashmap" resultType="hashmap">
        SELECT
            A.team_group_id,
            A.group_name,
            A.use_flag,
            IFNULL(B.cnt, '0') AS cnt,
            A.reg_date
        FROM
            Team_Group A
            LEFT JOIN(
                        SELECT
                            COUNT(1) AS cnt,
                            team_group_id
                        FROM
                            Team
                        WHERE
                            team_group_id IS NOT NULL
                        GROUP BY
                            team_group_id
            ) B ON A.team_group_id = B.team_group_id
        WHERE
            1=1
            <if test="sKeyword != null and !sKeyword.equals('') ">
                AND group_name LIKE CONCAT('%', #{sKeyword}, '%')
            </if>
        ORDER BY
            <if test="orderName != null and order != null ">
                <choose>
                    <when test="orderName == 'groupName' ">
                        group_name
                        <choose>
                            <when test="order == 'ASC'"> ASC, </when>
                            <otherwise> DESC, </otherwise>
                        </choose>
                    </when>
                    <when test="orderName == 'cnt' ">
                        cnt
                        <choose>
                            <when test="order == 'ASC'"> ASC, </when>
                            <otherwise> DESC, </otherwise>
                        </choose>
                    </when>
                    <when test="orderName == 'useFlag' ">
                        use_flag
                        <choose>
                            <when test="order == 'ASC'"> ASC, </when>
                            <otherwise> DESC, </otherwise>
                        </choose>
                    </when>
                </choose>
            </if>
            A.team_group_id DESC
        LIMIT ${sRow}, ${eCount}
    </select>

    <insert id="insertTeamGroup" parameterType="hashmap">
        INSERT INTO Team_Group
        (group_name, use_flag)
        VALUES
        (#{groupName}, #{useFlag});
        <selectKey resultType="String" keyProperty="teamGroupId" order="AFTER">
            SELECT LAST_INSERT_ID()
        </selectKey>
    </insert>

    <update id="updateTeamGroup" parameterType="hashmap">
        UPDATE Team_Group
        SET
            use_flag = #{useFlag},
            group_name = #{groupName}
        WHERE team_group_id = #{teamGroupId}
    </update>

    <update id="updateDeleteTeamGroup" parameterType="hashmap">
        UPDATE Team_Group
        SET
            use_flag = '1'
        WHERE
            team_group_id = #{teamGroupId}
    </update>

    <resultMap id="teamGroupResultMap" type="java.util.HashMap">
        <id property="team_group_id" column="team_group_id"/>
        <result property="group_name" column="group_name"/>
        <result property="use_flag" column="use_flag"/>
        <collection property="teams" ofType="java.util.HashMap" javaType="java.util.List">
            <result property="team_id" column="team_id"/>
            <result property="uage" column="uage"/>
            <result property="emblem" column="emblem"/>
            <result property="team_type" column="team_type"/>
            <result property="team_name" column="team_name"/>
            <result property="nick_name" column="nick_name"/>
            <result property="addr" column="addr"/>
        </collection>
    </resultMap>
    <select id="selectTeamGroupDetail" parameterType="hashmap" resultMap="teamGroupResultMap">
        SELECT
            A.team_group_id,
            A.group_name,
            A.use_flag,
            B.team_id,
            B.uage,
            B.emblem,
            B.team_type,
            B.team_name,
            B.nick_name,
            B.addr
        FROM
            Team_Group A
            LEFT JOIN Team B ON A.team_group_id = B.team_group_id
        WHERE
            A.team_group_id = #{teamGroupId}
    </select>

    <update id="updateTeamForGroup" parameterType="hashmap">
        <foreach collection="list" item="item" separator=";">
            UPDATE
                Team
            SET
                team_group_id = #{item.teamGroupId}
            WHERE
                team_id = #{item.childId}
        </foreach>
    </update>

    <update id="updateDeleteTeamForGroup" parameterType="hashmap">
        UPDATE
            Team
        SET
            team_group_id = NULL
        WHERE
            team_id = #{teamId}
    </update>

    <select id="selectCheckTeamGroupName" parameterType="hashmap" resultType="_int">
        SELECT
            COUNT(1)
        FROM
            Team_Group
        WHERE
            use_flag = 0
            AND group_name = #{groupName}
    </select>

    <select id="selectCheckTeam" parameterType="hashmap" resultType="hashmap">
        SELECT
            team_id,
            team_group_id
        FROM
            Team
        WHERE
            uage = #{uage}
            AND nick_name = #{nickName}
            AND use_flag = 0
    </select>

    <update id="updateTeamGroupIdForTeam" parameterType="hashmap">
        UPDATE
            Team
        SET
            team_group_id = #{teamGroupId}
        WHERE
            team_id = #{teamId}
    </update>
    
    <update id="updateTeamForNickName" parameterType="hashmap">
        UPDATE
            Team
        SET
            nick_name = #{newNickName}
        WHERE
            team_id = #{teamId}
    </update>
    
    <update id="updateTeamForTeamName" parameterType="hashmap">
        UPDATE
            Team
        SET
            team_name = #{newTeamName}
        WHERE
            team_id = #{teamId}
    </update>

    <select id="selectTeamListForExcelDown" parameterType="hashmap" resultType="java.util.LinkedHashMap">
        SELECT
            uage AS '연령',
            area_name AS '지역',
            CASE
                WHEN team_type = '0' THEN '학원'
                WHEN team_type = '1' THEN '클럽'
                WHEN team_type = '2' THEN '유스'
            END AS '팀 구분',
            team_name AS '정식명칭',
            nick_name AS '사용명칭',
            addr AS '소재지',
            CASE
                WHEN use_flag = '0' THEN '활성'
                ELSE '비활성'
            END AS '활성여부',
            IFNULL(pId_name, '') AS '팀연동'
        FROM Team
        WHERE uage REGEXP (#{ageGroup})

        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1') ">
            AND area_name = #{sArea}
        </if>
        <if test="sTeamType != null and !sTeamType.equals('') and !sTeamType.equals('-1') ">
            AND team_type = #{sTeamType}
        </if>
        <if test="sNickName != null and !sNickName.equals('') ">
            AND nick_name REGEXP (#{sNickName})
        </if>

        ORDER BY
        use_flag ASC,
        <if test="orderName != null and order != null ">
            <choose>
                <when test="orderName == 'key' ">
                    id
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'name' ">
                    name
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>
                <when test="orderName == 'address' ">
                    address
                    <choose>
                        <when test="order == 'ASC'"> ASC, </when>
                        <otherwise> DESC, </otherwise>
                    </choose>
                </when>

                <!-- <otherwise>
                    ,id ASC ,name ASC
                </otherwise> -->
            </choose>
        </if>
        <!-- 		team_id ASC -->
        team_name ASC

    </select>

    <update id="updateRemoveEmblem" parameterType="hashmap">
        UPDATE
            Team
        SET
            emblem = ''
        WHERE
            team_id = #{teamId}
    </update>

    <select id="selectTeamMgrListForExcelDown" parameterType="hashmap" resultType="java.util.LinkedHashMap">
        SELECT
        a.area_name AS '광역',
        CASE
            WHEN team_type = '0' THEN '학원'
            WHEN team_type = '1' THEN '클럽'
            WHEN team_type = '2' THEN '유스'
        END AS '팀 구분',
        a.nick_name AS '팀명',
        IFNULL(b.league_name, '-') AS '리그명',
        IFNULL(b.l_result, '-') AS '리그순위',
        IFNULL(b.l_points, '-') AS '리그승점',
        IFNULL(a.cup_name, '-') AS '대회명',
        IFNULL(a.c_result, '-') AS '대회순위',
        IFNULL( TRUNCATE( ( SUM(IFNULL(a.c_won, 0) + IFNULL(b.l_won, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) )*100 , 1 ), 0) AS '승률',
        SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) AS '경기',
        SUM(IFNULL(a.c_won, 0) + IFNULL(b.l_won, 0)) AS '승',
        SUM(IFNULL(a.c_draw, 0) + IFNULL(b.l_draw, 0)) AS '무',
        SUM(IFNULL(a.c_lost, 0) + IFNULL(b.l_lost, 0)) AS '패',
        SUM(IFNULL(a.c_gf, 0) + IFNULL(b.l_gf, 0)) AS '총득',
        SUM(IFNULL(a.c_ga, 0) + IFNULL(b.l_ga, 0)) AS '총실',
        IFNULL(TRUNCATE( SUM(IFNULL(a.c_gf, 0) + IFNULL(b.l_gf, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) , 1 ), 0) AS '평득',
        IFNULL(TRUNCATE( SUM(IFNULL(a.c_ga, 0) + IFNULL(b.l_ga, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)) , 1 ), 0) AS '평실',
        IFNULL(TRUNCATE(SUM(IFNULL(a.c_points, 0) + IFNULL(b.l_points, 0)) / SUM(IFNULL(a.c_played, 0) + IFNULL(b.l_played, 0)), 1), 0) AS '평승'
        FROM
        (
        SELECT
        a.team_id, a.area_name, a.team_type, a.nick_name, a.emblem, a.uage, a.use_flag,
        b.c_team_id, b.cup_id,
        /*b.c_result,*/
        CASE
        WHEN b.c_end_flag = '1' THEN b.c_result
        ELSE '진행중'
        END AS c_result,
        b.sub_rank, b.main_rank,
        b.cup_name, b.play_sdate, b.play_edate, b.cup_type,
        SUM(c_played) AS c_played,
        SUM(c_won) AS c_won,
        SUM(c_draw) AS c_draw,
        SUM(c_lost) AS c_lost,
        SUM(c_gf) AS c_gf,
        SUM(c_ga) AS c_ga,
        SUM(c_gd) AS c_gd,
        SUM(c_points) AS c_points
        FROM
        (
        SELECT
        team_id, uage, area_name, team_type, team_name, nick_name, emblem, use_flag
        FROM Team
        WHERE uage REGEXP (#{ageGroup})
        <if test="sArea != null and !sArea.equals('') and !sArea.equals('-1') ">
            AND area_name = #{sArea}
        </if>
        <if test="sTeamType != null and !sTeamType.equals('') and !sTeamType.equals('-1') ">
            AND team_type = #{sTeamType}
        </if>
        <if test="sNickName != null and !sNickName.equals('') ">
            AND nick_name REGEXP (#{sNickName})
        </if>
        ) a
        LEFT JOIN
        (
        SELECT
        b.cup_name, b.play_sdate, b.play_edate, b.cup_type, a.*
        , b.c_end_flag
        FROM
        (
        SELECT
        team_id AS c_team_id, cup_id,`result` AS c_result,sub_rank,main_rank,
        SUM(played1 + played2 + played3) AS c_played,
        SUM(won1 + won2 + won3) AS c_won,
        SUM(draw1 + draw2 + draw3) AS c_draw,
        SUM(lost1 + lost2 + lost3) AS c_lost,
        SUM(gf1 + gf2 + gf3) AS c_gf,
        SUM(ga1 + ga2 + ga3) AS c_ga,
        SUM(gd1 + gd2 + gd3) AS c_gd,
        SUM(points1 + points2 + points3) AS c_points,
        reg_date AS c_reg_date,mod_date1 AS c_mod_date1,mod_date2 AS c_mod_date2,mod_date3 AS c_mod_date3
        FROM ${cupResultTB}
        WHERE use_flag = 0
        GROUP BY cup_id, team_id
        ) a
        INNER JOIN
        (
        SELECT
        cup_id, cup_name, play_sdate, play_edate, cup_type
        , CASE
        WHEN play_edate > NOW() THEN '0'
        ELSE '1'
        END AS c_end_flag
        FROM ${cupInfoTB}
        WHERE
        use_flag = 0
        AND play_flag = 0
        <choose>
            <when test="sYear != null and sYear != '' ">
                AND play_sdate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND play_sdate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
                AND play_edate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND play_edate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
            </when>
            <otherwise>
                AND play_sdate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND play_sdate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
                AND play_edate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND play_edate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
            </otherwise>
        </choose>
        ) b ON a.cup_id = b.cup_id
        ORDER BY b.play_edate DESC
        ) b ON a.team_id = b.c_team_id
        GROUP BY a.team_id
        ) a
        LEFT JOIN
        (
        SELECT
        a.l_team_id, b.league_name, b.play_sdate, b.play_edate,
        a.league_id,
        /*a.l_result,*/
        CASE
        WHEN b.l_end_flag = '1' THEN a.l_result
        ELSE '진행중'
        END AS l_result,
        a.l_rank, a.l_points,
        SUM(a.l_played) AS l_played,
        SUM(a.l_won) AS l_won,
        SUM(a.l_draw) AS l_draw,
        SUM(a.l_lost) AS l_lost,
        SUM(a.l_gf) AS l_gf,
        SUM(a.l_ga) AS l_ga,
        SUM(a.l_gd) AS l_gd,
        l_reg_date, l_mod_date
        FROM
        (
        SELECT
        team_id as l_team_id, league_id,
        `result` AS l_result,
        `rank` AS l_rank,
        SUM( points + points_add ) AS l_points, played AS l_played,
        won AS l_won,draw AS l_draw,lost AS l_lost,gf AS l_gf,ga AS l_ga,gd AS l_gd,
        reg_date AS l_reg_date,mod_date AS l_mod_date
        FROM ${leagueResultTB}
        WHERE use_flag = 0
        GROUP BY league_id, team_id
        ORDER By league_id DESC
        ) a
        INNER JOIN
        (
        SELECT
        league_id, league_name, play_sdate, play_edate
        ,CASE
        WHEN play_edate > NOW() THEN '0'
        ELSE '1'
        END AS l_end_flag
        FROM ${leagueInfoTB}
        WHERE
        use_flag = 0
        AND play_flag = 0
        <choose>
            <when test="sYear != null and sYear != '' ">
                AND play_sdate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND play_sdate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
                AND play_edate <![CDATA[>=]]> CONCAT(#{sYear},"-01-01 00:00:00")
                AND play_edate <![CDATA[<=]]> CONCAT(#{sYear},"-12-31 23:59:59")
            </when>
            <otherwise>
                AND play_sdate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND play_sdate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
                AND play_edate <![CDATA[>=]]> CONCAT(YEAR(CURDATE()),"-01-01 00:00:00")
                AND play_edate <![CDATA[<=]]> CONCAT(YEAR(CURDATE()),"-12-31 23:59:59")
            </otherwise>
        </choose>
        ) b ON a.league_id = b.league_id
        GROUP BY a.l_team_id
        ORDER BY b.play_edate DESC
        ) b ON a.team_id = b.l_team_id
        GROUP BY a.team_id
        ORDER BY

        '승' DESC, '총득' DESC

    </select>

    <select id="selectTeamGroupListForExcelDown" parameterType="hashmap" resultType="java.util.LinkedHashMap">
        SELECT
            A.group_name AS '그룹명',
            CASE
                WHEN use_flag = '0' THEN '사용'
                ELSE '미사용'
            END AS '사용유무',
            IFNULL(B.cnt, '0') AS '소속팀 수'
        FROM
            Team_Group A
            LEFT JOIN(
                        SELECT
                            COUNT(1) AS cnt,
                            team_group_id
                        FROM
                            Team
                        WHERE
                            team_group_id IS NOT NULL
                        GROUP BY
                            team_group_id
            ) B ON A.team_group_id = B.team_group_id
        WHERE
            1=1
            <if test="sKeyword != null and !sKeyword.equals('') ">
                AND group_name LIKE CONCAT('%', #{sKeyword}, '%')
            </if>
        ORDER BY
        A.team_group_id DESC
    </select>

    <update id="deleteTeamGroup" parameterType="hashmap">
        UPDATE Team_Group
        SET use_flag = '1'
        WHERE team_group_id = #{teamGroupId}
    </update>

    <update id="deleteTeamGroupFromTeam" parameterType="hashmap">
        UPDATE Team
        SET team_group_id = NULL
        WHERE team_group_id = #{teamGroupId}
    </update>
    
    <select id="selectJoinKfaPlayerList" parameterType="hashmap" resultType="hashmap">
        SELECT 
			jkp.*, np.name, np.position, np.team_name
		FROM
			joinkfa_player jkp
    		INNER JOIN joinkfa_team jkt ON jkp.team_id = jkt.team_id
    		LEFT JOIN (
    					SELECT 
    						A.* 
						FROM (
								SELECT 
									MAX(ph.history_id) as history_id, 
									p.player_id,
									p.name,
									(
									SELECT
										t.team_name
									FROM 
										player_history pp
										INNER JOIN team t ON pp.team_id = t.team_id
									WHERE 
										pp.history_id = MAX(ph.history_id)
									) as team_name,
            						(
            						SELECT
										t.team_id
									FROM
										player_history pp
                						INNER JOIN team t ON pp.team_id = t.team_id
                					WHERE
										pp.history_id = MAX(ph.history_id)
            						) as team_id,
            						p.position,
            						p.birthday
								FROM 
									player_history ph
									INNER JOIN player p ON ph.player_id = p.player_id
								WHERE 
									p.use_flag = '0'
								AND p.delete_flag = '0'
								AND ph.use_flag = '0'
								AND ph.delete_flag = '0'
								GROUP BY p.player_id
						) A
    				) np ON jkp.np_player_id = np.player_id
		WHERE
			jkt.np_team_group_id = #{teamGroupId}
		AND jkt.use_flag = '0'
		AND jkp.use_flag = '0'
    </select>
    
    <select id="selectJoinKfaTeamList" parameterType="hashmap" resultType="hashmap">
        SELECT
        	 * 
		FROM
			joinkfa_team
		WHERE 
			reg_date >= DATE_FORMAT((SELECT MAX(reg_date) FROM joinkfa_team), '%Y-%m')
		AND use_flag = '0'
		AND team_name = #{originalGroupName}
    </select>
    
    <update id="updateJoinKfaTeam" parameterType="hashmap">
        UPDATE joinkfa_team SET 
        	np_team_group_id = #{npTeamGroupId},
    		np_team_id = #{npTeamId}
        WHERE
			team_id = #{joinKfaTeamId}
    </update>
    
    <select id="selectPlayerList" parameterType="hashmap" resultType="hashmap">
    	SELECT 
    		A.* 
		FROM (
				SELECT 
					MAX(ph.history_id) as history_id, 
					p.player_id,
					p.name,
					(
					SELECT
						t.team_name
					FROM 
						player_history pp
						INNER JOIN team t ON pp.team_id = t.team_id
					WHERE 
						pp.history_id = MAX(ph.history_id)
					) as team_name,
            		(
            		SELECT
						t.team_id
					FROM
						player_history pp
                		INNER JOIN team t ON pp.team_id = t.team_id
                	WHERE
						pp.history_id = MAX(ph.history_id)
            		) as team_id,
            		p.position,
            		p.birthday
				FROM 
					player_history ph
					INNER JOIN player p ON ph.player_id = p.player_id
				WHERE 
					p.use_flag = '0'
				AND p.delete_flag = '0'
				AND ph.use_flag = '0'
				AND ph.delete_flag = '0'
				GROUP BY p.player_id
		) A
		WHERE
			1 = 1
		<choose>
			<when test="keyword == null or keyword == ''">
				<if test="teamId != null and teamId != ''">
				AND A.team_id = #{teamId}
				</if>
				<if test="playerName != null and playerName != ''">
				AND A.name LIKE CONCAT('%', #{playerName}, '%')
				</if>
			</when>
			<otherwise>
				<if test="sType != null and sType != ''">
					<choose>
						<when test="sType == 'playerName'">
							AND A.name LIKE CONCAT('%', #{keyword}, '%')
						</when>
						<when test="sType == 'teamName'">
							AND A.team_name LIKE CONCAT('%', #{keyword}, '%')
						</when>
					</choose>
				</if>
				<if test="mType != null and mType != ''">
					<choose>
						<when test="mType == 'all'">
							AND A.name LIKE CONCAT('%', #{keyword}, '%')
						</when>
						<when test="mType == 'team'">
							AND A.team_id = #{teamId}
							AND A.name LIKE CONCAT('%', #{keyword}, '%')
						</when>
					</choose>
				</if>
			</otherwise>
		</choose>
    </select>
    
    <insert id="insertJoinKfaPlayer" parameterType="hashmap">
    	INSERT INTO joinkfa_player (
    			player_name,
    			<if test="playerPosition != null and playerPosition != ''">
    			player_position,
    			</if>
    			<if test="playerImg != null and playerImg != ''">
    			player_img,
    			</if>
    			<if test="playerBirthday != null and playerBirthday != ''">
    			player_birthday,
    			</if>
    			<if test="playerWeight != null and playerWeight != ''">
    			player_weight,
    			</if>
    			<if test="playerHeight != null and playerHeight != ''">
    			player_height,
    			</if>
    			<if test="playerImgBinary != null and playerImgBinary != ''">
    			player_img_binary,
    			</if>
    			<if test="playerId != null and playerId != ''">
    			np_player_id,
    			</if>
    			team_id
    		) VALUES (
    			#{playerName},
    			<if test="playerPosition != null and playerPosition != ''">
    			#{playerPosition},
    			</if>
    			<if test="playerImg != null and playerImg != ''">
    			#{playerImg},
    			</if>
    			<if test="playerBirthday != null and playerBirthday != ''">
    			#{playerBirthday},
    			</if>
    			<if test="playerWeight != null and playerWeight != ''">
    			#{playerWeight},
    			</if>
    			<if test="playerHeight != null and playerHeight != ''">
    			#{playerHeight},
    			</if>
    			<if test="playerImgBinary != null and playerImgBinary != ''">
    			#{playerImgBinary},
    			</if>
    			<if test="playerId != null and playerId != ''">
    			#{playerId},
    			</if>
    			#{teamId}
    		)
    </insert>
    
    <update id="updateOriginalTeamGroupName" parameterType="hashmap">
        UPDATE team_group SET 
        	original_group_name = #{originalGroupName}
        WHERE
			team_group_id = #{teamGroupId}
    </update>
    
    <update id="updateJoinKfaPlayer" parameterType="hashmap">
        UPDATE joinkfa_player SET 
        	player_name = #{playerName},
        	<if test="playerImg != null and playerImg != ''">
        	player_img = #{playerImg},
        	</if>
        	<if test="playerImgBinary != null and playerImgBinary != ''">
        	player_img_binary = #{playerImgBinary},
        	</if>
        	<if test="playerBirthday != null and playerBirthday != ''">
        	player_birthday = #{playerBirthday},
        	</if>
        	<if test="playerWeight != null and playerWeight != ''">
        	player_weight = #{playerWeight},
        	</if>
        	<if test="playerHeight != null and playerHeight != ''">
        	player_height = #{playerHeight},
        	</if>
        	player_position = #{playerPosition}
        WHERE
			player_id = #{playerId}
    </update>
    
    <update id="updateDeleteJoinKfaPlayer" parameterType="hashmap">
        UPDATE joinkfa_player SET 
        	use_flag = '1'
        WHERE
			player_id = #{playerId}
    </update>
    
    <update id="updateJoinKfaPlayerMapping" parameterType="hashmap">
        UPDATE joinkfa_player SET
        	<choose>
        		<when test="npPlayerId != null and npPlayerId != ''">
        			np_player_id = #{npPlayerId}
        		</when>
        		<otherwise>
        			np_player_id = NULL
        		</otherwise>
        	</choose>
        WHERE
			player_id = #{playerId}
    </update>
    
    <select id="selectJoinKfaTeamListSearch" parameterType="hashmap" resultType="hashmap">
        SELECT
        	 jkt.team_id, jkt.team_name, jkt.team_img, jkt.team_create_date, 
        	 jkt.team_address, jkt.team_contact, jkt.level, jkt.director, jkt.coach
		FROM
			joinkfa_team jkt
			LEFT JOIN team_group tg ON jkt.np_team_group_id = tg.team_group_id
		WHERE 
			jkt.reg_date >= DATE_FORMAT((SELECT MAX(reg_date) FROM joinkfa_team), '%Y-%m')
			AND jkt.use_flag = '0'
			<if test="searchTxt != null and searchTxt != ''">
			AND jkt.team_name LIKE CONCAT('%', #{searchTxt}, '%')
			</if>
    </select>
    
    <insert id="insertJoinKfaTeam" parameterType="hashmap">
    	INSERT INTO joinkfa_team (
    			team_name,
    			<if test="teamImg != null and teamImg != ''">
    			team_img,
    			</if>
    			<if test="teamCreateDate != null and teamCreateDate != ''">
    			team_create_date,
    			</if>
    			<if test="teamAddress != null and teamAddress != ''">
    			team_address,
    			</if>
    			<if test="teamContact != null and teamContact != ''">
    			team_contact,
    			</if>
    			level
    		) VALUES (
    			#{newTeamName},
    			<if test="teamImg != null and teamImg != ''">
    			#{teamImg},
    			</if>
    			<if test="teamCreateDate != null and teamCreateDate != ''">
    			#{teamCreateDate},
    			</if>
    			<if test="teamAddress != null and teamAddress != ''">
    			#{teamAddress},
    			</if>
    			<if test="teamContact != null and teamContact != ''">
    			#{teamContact},
    			</if>
    			#{level}
    		)
    </insert>
    
    <update id="updateDeleteJoinKfaTeam" parameterType="hashmap">
        UPDATE joinkfa_team SET 
        	use_flag = '1'
        WHERE
			team_id = #{kfaTeamId}
    </update>
    
    <update id="updateModJoinKfaTeam" parameterType="hashmap">
        UPDATE joinkfa_team SET 
        	<if test="teamImg != null and teamImg != ''">
        	team_img = #{teamImg},
        	</if>
        	<if test="teamCreateDate != null and teamCreateDate != ''">
        	team_create_date = #{teamCreateDate},
        	</if>
        	<if test="teamAddress != null and teamAddress != ''">
        	team_address = #{teamAddress},
        	</if>
        	<if test="teamContact != null and teamContact != ''">
        	team_contact = #{teamContact},
        	</if>
        	<if test="level != null and level != ''">
        	level = #{level},
        	</if>
        	team_name = #{newTeamName}
        WHERE
			team_id = #{kfaTeamId}
    </update>
    
    <select id="selectPlayerToName" parameterType="hashmap" resultType="hashmap">
    	SELECT 
    		A.* 
		FROM (
				SELECT 
					MAX(ph.history_id) as history_id, 
					p.player_id,
					p.name,
					(
					SELECT
						t.team_name
					FROM 
						player_history pp
						INNER JOIN team t ON pp.team_id = t.team_id
					WHERE 
						pp.history_id = MAX(ph.history_id)
					) as team_name,
            		(
            		SELECT
						t.team_id
					FROM
						player_history pp
                		INNER JOIN team t ON pp.team_id = t.team_id
                	WHERE
						pp.history_id = MAX(ph.history_id)
            		) as team_id,
            		p.position,
            		p.birthday,
            		p.use_flag,
            		p.delete_flag
				FROM 
					player_history ph
					INNER JOIN player p ON ph.player_id = p.player_id
				WHERE 
					p.use_flag = '0'
				AND p.delete_flag = '0'
				AND ph.use_flag = '0'
				AND ph.delete_flag = '0'
				GROUP BY p.player_id
		) A
		WHERE
			A.name = #{playerName} 
		AND A.use_flag = '0' 
		AND A.delete_flag = '0'
    </select>

</mapper>